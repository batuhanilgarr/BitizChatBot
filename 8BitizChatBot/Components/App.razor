@namespace BitizChatBot.Components

<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <base href="/" />
    <link rel="icon" type="image/svg+xml" href="favicon.svg" />
    <!-- Preconnect to FontAwesome CDNs -->
    <link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin />
    <link rel="preconnect" href="https://cdnjs.cloudflare.com" crossorigin />
    <link rel="dns-prefetch" href="https://cdn.jsdelivr.net" />
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com" />
    <!-- FontAwesome from cdnjs - most reliable for fonts -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" rel="stylesheet" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    @* Bootstrap ve app.css sadece embed route'u dışında yükle *@
    <script>
        // FontAwesome'u embed route için de yükle
        (function() {
            var pathname = window.location.pathname || '';
            var isEmbedRoute = pathname === '/embed' || pathname.endsWith('/embed') || pathname.includes('/chatbot/embed');
            
            // FontAwesome yükleme kontrolü - embed route için de çalışsın
            function ensureFontAwesome() {
                if (!document.querySelector('link[href*="font-awesome"]') && !document.querySelector('link[href*="fontawesome"]') && !document.querySelector('link[href*="fortawesome"]')) {
                    var faLink = document.createElement('link');
                    faLink.rel = 'stylesheet';
                    faLink.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css';
                    faLink.crossOrigin = 'anonymous';
                    faLink.referrerPolicy = 'no-referrer';
                    document.head.insertBefore(faLink, document.head.firstChild);
                }
            }
            ensureFontAwesome();
            
            // Bootstrap ve app.css sadece embed route dışında yükle
            if (!isEmbedRoute) {
                var bootstrapLink = document.createElement('link');
                bootstrapLink.rel = 'stylesheet';
                bootstrapLink.href = 'bootstrap/bootstrap.min.css';
                document.head.appendChild(bootstrapLink);
                
                var appCssLink = document.createElement('link');
                appCssLink.rel = 'stylesheet';
                appCssLink.href = 'app.css';
                document.head.appendChild(appCssLink);
            }
        })();
    </script>
    <HeadOutlet />
</head>

<body>
    <BitizChatBot.Components.Routes />
    <script src="_framework/blazor.web.js"></script>
    <script>
        window.scrollToBottom = (element) => {
            if (element) {
                // Use requestAnimationFrame for smooth scrolling
                requestAnimationFrame(() => {
                    element.scrollTop = element.scrollHeight;
                    // Also try smooth scroll behavior
                    element.scrollTo({
                        top: element.scrollHeight,
                        behavior: 'smooth'
                    });
                });
            }
        };

        window.getCurrentLocation = () => {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    resolve({ success: false, error: 'Tarayıcınız konum servisini desteklemiyor' });
                    return;
                }

                // Check if we're in an iframe and if geolocation is allowed
                var isInIframe = window.self !== window.top;
                if (isInIframe) {
                    console.log('Geolocation request from iframe');
                }

                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        resolve({
                            success: true,
                            latitude: position.coords.latitude,
                            longitude: position.coords.longitude
                        });
                    },
                    (error) => {
                        var errorMessage = 'Konum izni verilmedi veya konum alınamadı';
                        
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                errorMessage = 'Konum izni reddedildi. Lütfen tarayıcı ayarlarından konum iznini etkinleştirin.';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                errorMessage = 'Konum bilgisi alınamadı. GPS veya ağ bağlantınızı kontrol edin.';
                                break;
                            case error.TIMEOUT:
                                errorMessage = 'Konum isteği zaman aşımına uğradı. Lütfen tekrar deneyin.';
                                break;
                            default:
                                errorMessage = error.message || 'Konum alınırken bir hata oluştu.';
                                break;
                        }
                        
                        resolve({
                            success: false,
                            error: errorMessage
                        });
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 15000,
                        maximumAge: 0
                    }
                );
            });
        };

        // Setup Enter key handler for chat input
        window.setupChatInputEnterKey = (element, dotNetHelper) => {
            if (element) {
                element.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        // Find the submit button and click it
                        const form = element.closest('form');
                        if (form) {
                            const submitButton = form.querySelector('button[type="submit"]');
                            if (submitButton && !submitButton.disabled) {
                                submitButton.click();
                            }
                        }
                    }
                });
            }
        };

        // Download text file
        window.downloadTextFile = (filename, text) => {
            const element = document.createElement('a');
            const file = new Blob([text], { type: 'text/plain;charset=utf-8' });
            element.href = URL.createObjectURL(file);
            element.download = filename;
            document.body.appendChild(element);
            element.click();
            document.body.removeChild(element);
            URL.revokeObjectURL(element.href);
        };

        // Focus element
        window.focusElement = (element) => {
            if (element) {
                element.focus();
            }
        };

        // Play chat sounds
        window.playChatSound = (soundType) => {
            try {
                // Create audio context for sound generation
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                
                if (soundType === 'typing') {
                    // Soft typing sound (subtle beep)
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    oscillator.frequency.value = 800;
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.1, audioContext.currentTime + 0.01);
                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.1);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.1);
                } else if (soundType === 'message') {
                    // Message received sound (pleasant notification)
                    const oscillator = audioContext.createOscillator();
                    const gainNode = audioContext.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(audioContext.destination);
                    
                    // Two-tone notification sound
                    oscillator.frequency.setValueAtTime(600, audioContext.currentTime);
                    oscillator.frequency.setValueAtTime(800, audioContext.currentTime + 0.1);
                    oscillator.type = 'sine';
                    
                    gainNode.gain.setValueAtTime(0, audioContext.currentTime);
                    gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.01);
                    gainNode.gain.linearRampToValueAtTime(0.15, audioContext.currentTime + 0.15);
                    gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.2);
                    
                    oscillator.start(audioContext.currentTime);
                    oscillator.stop(audioContext.currentTime + 0.2);
                }
            } catch (error) {
                // Silently fail if audio is not supported or user interaction required
                console.log('Sound playback not available:', error);
            }
        };
    </script>
    <script src="app.js"></script>
</body>

</html>

