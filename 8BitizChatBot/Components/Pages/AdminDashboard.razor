@page "/admin"
@namespace BitizChatBot.Components.Pages
@using BitizChatBot.Models
@using BitizChatBot.Services
@using Microsoft.AspNetCore.Components.Web
@inject IAdminSettingsService AdminSettingsService
@inject IOllamaService OllamaService
@inject IDomainApiKeyService DomainApiKeyService
@inject IDomainAppearanceService DomainAppearanceService
@inject IUserService UserService
@inject IAuditLogService AuditLogService
@inject IAnalyticsService AnalyticsService
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime
@rendermode RenderMode.InteractiveServer

<PageTitle>Admin Dashboard - LLM Settings</PageTitle>

<div class="admin-wrapper">
    <div class="admin-container">
        @if (!_authChecked)
        {
            <div class="loading-container">
                <div class="spinner"></div>
                <p>Loading...</p>
            </div>
        }
        else if (!_isAuthenticated)
        {
            <div class="login-card">
                <h2>ğŸ” Admin GiriÅŸi</h2>
                <p>LÃ¼tfen admin kullanÄ±cÄ± adÄ± ve ÅŸifrenizi girin.</p>
                <EditForm Model="@_loginModel" OnValidSubmit="HandleLogin">
                    <DataAnnotationsValidator />
                    <div class="form-group">
                        <label for="loginUser">KullanÄ±cÄ± AdÄ±</label>
                        <InputText id="loginUser" @bind-Value="_loginModel.Username" class="form-control" />
                    </div>
                    <div class="form-group">
                        <label for="loginPass">Åifre</label>
                        <InputText id="loginPass" @bind-Value="_loginModel.Password" type="password" class="form-control" />
                    </div>
                    @if (!string.IsNullOrEmpty(_loginError))
                    {
                        <div class="alert alert-error">
                            @_loginError
                        </div>
                    }
                    <button type="submit" class="btn btn-primary">GiriÅŸ Yap</button>
                </EditForm>
            </div>
        }
        else
        {

        <div class="admin-header">
            <h1>ğŸ”§ Admin Dashboard</h1>
            <p class="subtitle">LLM Provider & Chatbot Configuration</p>
        </div>

        <div class="tabs">
            <button class="tab-button @(_activeTab == "llm" ? "active" : "")" @onclick='async () => await SetActiveTab("llm")'>
                ğŸ¤– LLM Settings
            </button>
            <button class="tab-button @(_activeTab == "appearance" ? "active" : "")" @onclick='async () => await SetActiveTab("appearance")'>
                ğŸ¨ Chatbot Appearance
            </button>
            <button class="tab-button @(_activeTab == "domains" ? "active" : "")" @onclick='async () => await SetActiveTab("domains")'>
                ğŸŒ Domain & API Keys
            </button>
            <button class="tab-button @(_activeTab == "users" ? "active" : "")" @onclick='async () => await SetActiveTab("users")'>
                ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi
            </button>
            <button class="tab-button @(_activeTab == "logs" ? "active" : "")" @onclick='async () => await SetActiveTab("logs")'>
                ğŸ“‹ Audit Logs
            </button>
            <button class="tab-button @(_activeTab == "analytics" ? "active" : "")" @onclick='async () => await SetActiveTab("analytics")'>
                ğŸ“Š Analytics
            </button>
        </div>

        @if (_isLoading)
        {
            <div class="loading-container">
                <div class="spinner"></div>
                <p>Loading settings...</p>
            </div>
        }
        else if (_showSuccess)
        {
            <div class="alert alert-success">
                <strong>âœ“ Success!</strong> Settings saved successfully.
            </div>
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <div class="alert alert-error">
                <strong>âœ— Error:</strong> @_errorMessage
            </div>
        }

        <EditForm Model="@_settings" OnValidSubmit="HandleSave">
            <DataAnnotationsValidator />
            
            @if (!_isAuthenticated)
            {
                <!-- Hide settings when not authenticated -->
            }
            else if (_activeTab == "llm")
            {
                <div class="settings-form">
                <div class="form-group">
                    <label for="llmProvider">LLM Provider</label>
                    <InputSelect id="llmProvider" @bind-Value="_settings.LlmProvider" class="form-control" @onchange="HandleProviderChange">
                        <option value="Ollama">Ollama (Local LLM)</option>
                        <option value="OpenAI">OpenAI</option>
                        <option value="Anthropic">Anthropic (Claude)</option>
                    </InputSelect>
                    <ValidationMessage For="@(() => _settings.LlmProvider)" />
                </div>

                @if (_settings.LlmProvider == "Ollama")
                {
                    <div class="form-group">
                        <label for="ollamaBaseUrl">Ollama Base URL</label>
                        <div class="input-with-button">
                            <InputText id="ollamaBaseUrl" 
                                       @bind-Value="_settings.OllamaBaseUrl" 
                                       class="form-control" 
                                       placeholder="http://3.14.208.235:11434" />
                            <button type="button" 
                                    class="btn btn-test" 
                                    @onclick="HandleTestConnection"
                                    disabled="@_isTestingConnection">
                                @if (_isTestingConnection)
                                {
                                    <span>Testing...</span>
                                }
                                else
                                {
                                    <span>ğŸ”Œ Test Connection</span>
                                }
                            </button>
                        </div>
                        <ValidationMessage For="@(() => _settings.OllamaBaseUrl)" />
                        <small class="form-text">Ollama server URL (e.g., http://3.14.208.235:11434)</small>
                        @if (_connectionStatus == "success")
                        {
                            <div class="connection-status success">âœ“ Connection successful!</div>
                        }
                        else if (_connectionStatus == "error")
                        {
                            <div class="connection-status error">âœ— Connection failed. Please check the URL.</div>
                        }
                    </div>

                    @if (_availableModels.Any())
                    {
                        <div class="form-group">
                            <label for="modelSelect">Select Model</label>
                            <InputSelect id="modelSelect" 
                                         @bind-Value="_settings.ModelName" 
                                         class="form-control">
                                <option value="">-- Select a model --</option>
                                @foreach (var model in _availableModels)
                                {
                                    <option value="@model">@model</option>
                                }
                            </InputSelect>
                            <small class="form-text">Available models from Ollama server</small>
                        </div>
                    }
                    else if (_connectionStatus == "success")
                    {
                        <div class="form-group">
                            <label for="modelName">Model Name</label>
                            <InputText id="modelName" 
                                       @bind-Value="_settings.ModelName" 
                                       class="form-control" 
                                       placeholder="e.g., hermes3:8b, qwen3:8b" />
                            <ValidationMessage For="@(() => _settings.ModelName)" />
                            <small class="form-text">Enter model name manually</small>
                        </div>
                    }
                    else
                    {
                        <div class="form-group">
                            <label for="modelName">Model Name</label>
                            <InputText id="modelName" 
                                       @bind-Value="_settings.ModelName" 
                                       class="form-control" 
                                       placeholder="e.g., hermes3:8b, qwen3:8b" />
                            <ValidationMessage For="@(() => _settings.ModelName)" />
                            <small class="form-text">Test connection first to load available models</small>
                        </div>
                    }
                }
                else
                {
                    <div class="form-group">
                        <label for="modelName">Model Name</label>
                        <InputText id="modelName" 
                                   @bind-Value="_settings.ModelName" 
                                   class="form-control" 
                                   placeholder="e.g., gpt-4o, gpt-4, claude-3-opus" />
                        <ValidationMessage For="@(() => _settings.ModelName)" />
                        <small class="form-text">
                            Examples: gpt-4o, gpt-4, gpt-3.5-turbo, claude-3-opus, claude-3-sonnet
                        </small>
                    </div>
                }

                @if (_settings.LlmProvider != "Ollama")
                {
                    <div class="form-group">
                        <label for="apiKey">API Key</label>
                        <InputText id="apiKey" 
                                   @bind-Value="_settings.ApiKey" 
                                   type="password" 
                                   class="form-control" 
                                   placeholder="Enter your API key" />
                        <ValidationMessage For="@(() => _settings.ApiKey)" />
                        <small class="form-text">Your API key is stored securely in appsettings.llm.json.</small>
                    </div>
                }

                <div class="form-group">
                    <label for="systemPrompt">System Prompt</label>
                    <InputTextArea id="systemPrompt" 
                                   @bind-Value="_settings.SystemPrompt" 
                                   class="form-control system-prompt" 
                                   rows="6"
                                   placeholder="Enter the system prompt for the chatbot..." />
                    <ValidationMessage For="@(() => _settings.SystemPrompt)" />
                    <small class="form-text">This prompt defines the chatbot's behavior and personality.</small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="temperature">Temperature</label>
                        <InputNumber id="temperature" 
                                     @bind-Value="_settings.Temperature" 
                                     class="form-control" 
                                     min="0" 
                                     max="2" 
                                     step="0.1" />
                        <ValidationMessage For="@(() => _settings.Temperature)" />
                        <small class="form-text">Controls randomness (0.0 = deterministic, 2.0 = creative)</small>
                    </div>

                    <div class="form-group">
                        <label for="maxTokens">Max Tokens</label>
                        <InputNumber id="maxTokens" 
                                     @bind-Value="_settings.MaxTokens" 
                                     class="form-control" 
                                     min="100" 
                                     max="8000" />
                        <ValidationMessage For="@(() => _settings.MaxTokens)" />
                        <small class="form-text">Maximum tokens in the response</small>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn btn-primary" disabled="@_isSaving">
                        @if (_isSaving)
                        {
                            <span>Saving...</span>
                        }
                        else
                        {
                            <span>ğŸ’¾ Save Settings</span>
                        }
                    </button>
                    <button type="button" class="btn btn-secondary" @onclick="HandleReset">ğŸ”„ Reset to Defaults</button>
                </div>
                </div>
            }
            else if (_activeTab == "appearance")
            {
                <div class="settings-form">
                    <h2 class="section-title">ğŸ¨ Chatbot GÃ¶rÃ¼nÃ¼m AyarlarÄ±</h2>
                    
                    <div class="form-group inline-checkbox">
                        <InputCheckbox id="chatbotOnline"
                                       @bind-Value="_settings.ChatbotOnline"
                                       class="form-checkbox" />
                        <label for="chatbotOnline">Chatbot Ã§evrimiÃ§i</label>
                        <small class="form-text">KapatÄ±ldÄ±ÄŸÄ±nda widget Ã§evrimdÄ±ÅŸÄ± gÃ¶rÃ¼nÃ¼r ve mesaj gÃ¶nderilemez.</small>
                    </div>

                    <div class="form-group inline-checkbox">
                        <InputCheckbox id="openChatOnLoad"
                                       @bind-Value="_settings.OpenChatOnLoad"
                                       class="form-checkbox" />
                        <label for="openChatOnLoad">Sayfa yÃ¼klendiÄŸinde sohbet penceresi aÃ§Ä±k gelsin</label>
                        <small class="form-text">Ä°ÅŸaretlenirse kullanÄ±cÄ± siteye girdiÄŸinde sohbet penceresi otomatik aÃ§Ä±k olur.</small>
                    </div>

                    <div class="form-group">
                        <label for="chatbotName">Chatbot AdÄ±</label>
                        <InputText id="chatbotName" 
                                   @bind-Value="_settings.ChatbotName" 
                                   class="form-control" 
                                   placeholder="Bridgestone Chatbot" />
                        <small class="form-text">Chatbot widget'Ä±nda gÃ¶rÃ¼necek isim</small>
                    </div>

                    <div class="form-group">
                        <label for="chatbotLogoUrl">Logo URL</label>
                        <InputText id="chatbotLogoUrl" 
                                   @bind-Value="_settings.ChatbotLogoUrl" 
                                   class="form-control" 
                                   placeholder="https://example.com/logo.png" />
                        <small class="form-text">Chatbot widget'Ä±nda gÃ¶sterilecek logo URL'i (opsiyonel)</small>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="primaryColor">Ana Renk</label>
                            <InputText id="primaryColor" 
                                       @bind-Value="_settings.PrimaryColor" 
                                       type="color"
                                       class="form-control color-input" />
                            <small class="form-text">Chatbot'un ana rengi (varsayÄ±lan: siyah)</small>
                        </div>

                        <div class="form-group">
                            <label for="secondaryColor">Vurgu Rengi</label>
                            <InputText id="secondaryColor" 
                                       @bind-Value="_settings.SecondaryColor" 
                                       type="color"
                                       class="form-control color-input" />
                            <small class="form-text">Chatbot'un vurgu rengi (varsayÄ±lan: kÄ±rmÄ±zÄ±)</small>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="welcomeMessage">HoÅŸ Geldiniz MesajÄ±</label>
                        <InputTextArea id="welcomeMessage" 
                                       @bind-Value="_settings.WelcomeMessage" 
                                       class="form-control" 
                                       rows="5"
                                       placeholder="Merhaba! Bridgestone chatbot'una hoÅŸ geldiniz..." />
                        <small class="form-text">Chatbot aÃ§Ä±ldÄ±ÄŸÄ±nda gÃ¶sterilecek hoÅŸ geldiniz mesajÄ±</small>
                    </div>

                    <h3 class="subsection-title">âš¡ï¸ HazÄ±r Mesajlar</h3>
                    <p class="subsection-description">Her satÄ±r ayrÄ± bir hazÄ±r mesaj olacak. Ã–rnek: "Konumuma yakÄ±n bayileri arÄ±yorum"</p>
                    <div class="form-group">
                        <label for="quickReplies">HazÄ±r Mesaj Listesi</label>
                        <InputTextArea id="quickReplies"
                                       @bind-Value="_quickRepliesText"
                                       class="form-control"
                                       rows="3"
                                       placeholder="Her satÄ±ra bir mesaj yazÄ±n" />
                        <small class="form-text">KullanÄ±cÄ± widget iÃ§inde buton olarak gÃ¶rÃ¼r ve tÄ±klayÄ±nca mesaj gÃ¶nderilir.</small>
                    </div>

                    <h3 class="subsection-title">ğŸ’¬ HazÄ±r Cevaplar</h3>
                    <p class="subsection-description">KullanÄ±cÄ±larÄ±n belirli sorularÄ±na verilecek hazÄ±r cevaplarÄ± dÃ¼zenleyin</p>

                    <div class="form-group">
                        <label for="greetingResponse">Selamlama CevabÄ±</label>
                        <InputTextArea id="greetingResponse" 
                                       @bind-Value="_settings.GreetingResponse" 
                                       class="form-control" 
                                       rows="2" />
                        <small class="form-text">"Merhaba", "Selam" gibi selamlamalara verilecek cevap</small>
                    </div>

                    <div class="form-group">
                        <label for="howAreYouResponse">NasÄ±lsÄ±n CevabÄ±</label>
                        <InputTextArea id="howAreYouResponse" 
                                       @bind-Value="_settings.HowAreYouResponse" 
                                       class="form-control" 
                                       rows="2" />
                        <small class="form-text">"NasÄ±lsÄ±n" sorularÄ±na verilecek cevap</small>
                    </div>

                    <div class="form-group">
                        <label for="whoAreYouResponse">Kimsin CevabÄ±</label>
                        <InputTextArea id="whoAreYouResponse" 
                                       @bind-Value="_settings.WhoAreYouResponse" 
                                       class="form-control" 
                                       rows="3" />
                        <small class="form-text">"Kimsin" sorularÄ±na verilecek cevap</small>
                    </div>

                    <div class="form-group">
                        <label for="whatCanYouDoResponse">Ne Yapabilirsin CevabÄ±</label>
                        <InputTextArea id="whatCanYouDoResponse" 
                                       @bind-Value="_settings.WhatCanYouDoResponse" 
                                       class="form-control" 
                                       rows="5" />
                        <small class="form-text">"Ne yapabilirsin" sorularÄ±na verilecek cevap</small>
                    </div>

                    <div class="form-group">
                        <label for="thanksResponse">TeÅŸekkÃ¼r CevabÄ±</label>
                        <InputTextArea id="thanksResponse" 
                                       @bind-Value="_settings.ThanksResponse" 
                                       class="form-control" 
                                       rows="2" />
                        <small class="form-text">"TeÅŸekkÃ¼r" mesajlarÄ±na verilecek cevap</small>
                    </div>

                    <div class="form-group">
                        <label for="goodbyeResponse">Veda CevabÄ±</label>
                        <InputTextArea id="goodbyeResponse" 
                                       @bind-Value="_settings.GoodbyeResponse" 
                                       class="form-control" 
                                       rows="2" />
                        <small class="form-text">"GÃ¼le gÃ¼le", "HoÅŸÃ§a kal" gibi vedalara verilecek cevap</small>
                    </div>

                    <div class="form-actions">
                        <button type="submit" class="btn btn-primary" disabled="@_isSaving">
                            @if (_isSaving)
                            {
                                <span>Saving...</span>
                            }
                            else
                            {
                                <span>ğŸ’¾ Save Settings</span>
                            }
                        </button>
                        <button type="button" class="btn btn-secondary" @onclick="HandleResetAppearance">ğŸ”„ Reset to Defaults</button>
                    </div>
                </div>
            }
            else if (_activeTab == "domains")
            {
                <div class="settings-form">
                    <h2 class="section-title">ğŸŒ Domain & API Key YÃ¶netimi</h2>
                    <p class="subsection-description">
                        Bu bÃ¶lÃ¼mde hangi domain'lerin bu chatbot'u kullanabileceÄŸini ve onlara ait API key'leri yÃ¶netebilirsiniz. Her domain iÃ§in gÃ¶rÃ¼nÃ¼m ayarlarÄ±nÄ± dÃ¼zenlemek iÃ§in <strong>Edit</strong> butonuna tÄ±klayÄ±n.
                    </p>

                    <div class="form-actions space-between">
                        <button type="button" class="btn btn-primary" @onclick="HandleNewDomainKey">+ New Key</button>
                    </div>

                    @if (_domainKeys.Any())
                    {
                        <div class="table-container-modern">
                            <table class="table-modern">
                            <thead>
                                <tr>
                                    <th>Domain</th>
                                    <th>API Key</th>
                                    <th>Durum</th>
                                    <th>OluÅŸturulma</th>
                                    <th>Ä°ÅŸlemler</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var key in _domainKeys)
                                {
                                    <tr>
                                        <td><strong>@key.Domain</strong></td>
                                        <td>
                                            <code class="api-key-code">@key.ApiKey</code>
                                        </td>
                                        <td>
                                            <span class="status-badge @(key.IsActive ? "active" : "inactive")">
                                                @(key.IsActive ? "Aktif" : "Pasif")
                                            </span>
                                        </td>
                                        <td>@key.CreatedAt.ToLocalTime().ToString("g")</td>
                                        <td>
                                            <div class="action-buttons">
                                                <button type="button"
                                                        class="btn btn-edit btn-sm"
                                                        @onclick="() => HandleEditDomain(key.Domain)">
                                                    âœï¸ Edit
                                                </button>
                                                <button type="button"
                                                        class="btn btn-info btn-sm"
                                                        @onclick="() => HandleCopyScript(key.Domain, key.ApiKey)">
                                                    ğŸ“‹ Script
                                                </button>
                                                <button type="button"
                                                        class="btn btn-danger btn-sm"
                                                        @onclick="() => HandleDeleteDomainKey(key.Id)">
                                                    ğŸ—‘ï¸ Sil
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state-modern">
                            <div class="empty-icon">ğŸŒ</div>
                            <p>HenÃ¼z tanÄ±mlanmÄ±ÅŸ bir domain yok. Yeni bir anahtar oluÅŸturmak iÃ§in <strong>New Key</strong> butonuna tÄ±klayÄ±n.</p>
                        </div>
                    }
                </div>

                @* Domain Appearance Edit Modal *@
                @if (_showEditModal)
                {
                    <div class="modal-overlay" @onclick="CloseEditModal">
                        <div class="modal-content" @onclick:stopPropagation="true">
                            <div class="modal-header">
                                <h3>ğŸ–Œï¸ GÃ¶rÃ¼nÃ¼m AyarlarÄ±: @_editingDomain</h3>
                                <button type="button" class="modal-close" @onclick="CloseEditModal">âœ•</button>
                            </div>
                            <div class="modal-body">
                                @if (_isDomainAppearanceLoading)
                                {
                                    <div class="loading-container">
                                        <div class="spinner"></div>
                                        <p>YÃ¼kleniyor...</p>
                                    </div>
                                }
                                else
                                {
                                    <div class="form-group inline-checkbox">
                                        <InputCheckbox id="daChatbotOnline"
                                                       @bind-Value="_domainAppearance.ChatbotOnline"
                                                       class="form-checkbox" />
                                        <label for="daChatbotOnline">Chatbot Ã§evrimiÃ§i</label>
                                        <small class="form-text">KapatÄ±ldÄ±ÄŸÄ±nda widget Ã§evrimdÄ±ÅŸÄ± gÃ¶rÃ¼nÃ¼r ve mesaj gÃ¶nderilemez.</small>
                                    </div>

                                    <div class="form-group inline-checkbox">
                                        <InputCheckbox id="daOpenChatOnLoad"
                                                       @bind-Value="_domainAppearance.OpenChatOnLoad"
                                                       class="form-checkbox" />
                                        <label for="daOpenChatOnLoad">Sayfa yÃ¼klendiÄŸinde sohbet penceresi aÃ§Ä±k gelsin</label>
                                    </div>

                                    <div class="form-group">
                                        <label for="daChatbotName">Chatbot AdÄ±</label>
                                        <InputText id="daChatbotName"
                                                   @bind-Value="_domainAppearance.ChatbotName"
                                                   class="form-control" />
                                    </div>

                                    <div class="form-group">
                                        <label for="daChatbotLogoUrl">Logo URL</label>
                                        <InputText id="daChatbotLogoUrl"
                                                   @bind-Value="_domainAppearance.ChatbotLogoUrl"
                                                   class="form-control" />
                                    </div>

                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="daPrimaryColor">Ana Renk</label>
                                            <InputText id="daPrimaryColor"
                                                       @bind-Value="_domainAppearance.PrimaryColor"
                                                       type="color"
                                                       class="form-control color-input" />
                                        </div>
                                        <div class="form-group">
                                            <label for="daSecondaryColor">Vurgu Rengi</label>
                                            <InputText id="daSecondaryColor"
                                                       @bind-Value="_domainAppearance.SecondaryColor"
                                                       type="color"
                                                       class="form-control color-input" />
                                        </div>
                                    </div>

                                    <div class="form-group">
                                        <label for="daWelcomeMessage">HoÅŸ Geldiniz MesajÄ±</label>
                                        <InputTextArea id="daWelcomeMessage"
                                                       @bind-Value="_domainAppearance.WelcomeMessage"
                                                       class="form-control"
                                                       rows="4" />
                                    </div>

                                    <h3 class="subsection-title">âš¡ï¸ HazÄ±r Mesajlar</h3>
                                    <p class="subsection-description">Bu domain iÃ§in Ã¶zel quick reply mesajlarÄ±. Her satÄ±r bir buton.</p>
                                    <div class="form-group">
                                        <label for="daQuickReplies">HazÄ±r Mesaj Listesi</label>
                                        <InputTextArea id="daQuickReplies"
                                                       @bind-Value="_domainQuickRepliesText"
                                                       class="form-control"
                                                       rows="3" />
                                        <small class="form-text">Her satÄ±r ayrÄ± bir hazÄ±r mesaj olacak. Ã–rnek: "Konumuma yakÄ±n bayileri arÄ±yorum"</small>
                                    </div>

                                    <h3 class="subsection-title">ğŸ’¬ HazÄ±r Cevaplar</h3>
                                    <p class="subsection-description">KullanÄ±cÄ±larÄ±n belirli sorularÄ±na verilecek hazÄ±r cevaplarÄ± dÃ¼zenleyin</p>

                                    <div class="form-group">
                                        <label for="daGreetingResponse">Selamlama CevabÄ±</label>
                                        <InputTextArea id="daGreetingResponse"
                                                       @bind-Value="_domainAppearance.GreetingResponse"
                                                       class="form-control"
                                                       rows="2" />
                                        <small class="form-text">"Merhaba", "Selam" gibi selamlamalara verilecek cevap</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="daHowAreYouResponse">NasÄ±lsÄ±n CevabÄ±</label>
                                        <InputTextArea id="daHowAreYouResponse"
                                                       @bind-Value="_domainAppearance.HowAreYouResponse"
                                                       class="form-control"
                                                       rows="2" />
                                        <small class="form-text">"NasÄ±lsÄ±n" sorularÄ±na verilecek cevap</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="daWhoAreYouResponse">Kimsin CevabÄ±</label>
                                        <InputTextArea id="daWhoAreYouResponse"
                                                       @bind-Value="_domainAppearance.WhoAreYouResponse"
                                                       class="form-control"
                                                       rows="2" />
                                        <small class="form-text">"Kimsin" sorularÄ±na verilecek cevap</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="daWhatCanYouDoResponse">Ne Yapabilirsin CevabÄ±</label>
                                        <InputTextArea id="daWhatCanYouDoResponse"
                                                       @bind-Value="_domainAppearance.WhatCanYouDoResponse"
                                                       class="form-control"
                                                       rows="3" />
                                        <small class="form-text">"Ne yapabilirsin" sorularÄ±na verilecek cevap</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="daThanksResponse">TeÅŸekkÃ¼r CevabÄ±</label>
                                        <InputTextArea id="daThanksResponse"
                                                       @bind-Value="_domainAppearance.ThanksResponse"
                                                       class="form-control"
                                                       rows="2" />
                                        <small class="form-text">"TeÅŸekkÃ¼r" mesajlarÄ±na verilecek cevap</small>
                                    </div>

                                    <div class="form-group">
                                        <label for="daGoodbyeResponse">Veda CevabÄ±</label>
                                        <InputTextArea id="daGoodbyeResponse"
                                                       @bind-Value="_domainAppearance.GoodbyeResponse"
                                                       class="form-control"
                                                       rows="2" />
                                        <small class="form-text">"GÃ¼le gÃ¼le", "HoÅŸÃ§a kal" gibi vedalara verilecek cevap</small>
                                    </div>
                                }
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-secondary" @onclick="CloseEditModal">Ä°ptal</button>
                                <button type="button" class="btn btn-primary" disabled="@_isSaving" @onclick="HandleSaveDomainAppearance">
                                    @if (_isSaving)
                                    {
                                        <span>Saving...</span>
                                    }
                                    else
                                    {
                                        <span>ğŸ’¾ Kaydet</span>
                                    }
                                </button>
                            </div>
                        </div>
                    </div>
                }
            }
        </EditForm>

        @if (_activeTab == "llm" && _isAuthenticated)
        {
            <div class="settings-info">
                <h3>â„¹ï¸ Current Configuration</h3>
                <div class="info-grid">
                    <div class="info-item">
                        <strong>Provider:</strong> @_settings.LlmProvider
                    </div>
                    <div class="info-item">
                        <strong>Model:</strong> @_settings.ModelName
                    </div>
                    @if (_settings.LlmProvider == "Ollama")
                    {
                        <div class="info-item">
                            <strong>Ollama URL:</strong> @_settings.OllamaBaseUrl
                        </div>
                    }
                    <div class="info-item">
                        <strong>Temperature:</strong> @_settings.Temperature.ToString("F2")
                    </div>
                    <div class="info-item">
                        <strong>Max Tokens:</strong> @_settings.MaxTokens
                    </div>
                    <div class="info-item">
                        <strong>Last Updated:</strong> @_settings.UpdatedAt.ToString("g")
                    </div>
                </div>
            </div>
        }
            else if (_activeTab == "users")
            {
                <div class="settings-form">
                    <h2 class="section-title">ğŸ‘¥ KullanÄ±cÄ± YÃ¶netimi</h2>
                    <p class="subsection-description">
                        Admin kullanÄ±cÄ±larÄ±nÄ± yÃ¶netebilir, yeni kullanÄ±cÄ± ekleyebilir, ÅŸifre deÄŸiÅŸtirebilir ve kullanÄ±cÄ±larÄ± aktif/pasif yapabilirsiniz.
                    </p>

                    <div class="form-actions space-between">
                        <button type="button" class="btn btn-primary" @onclick="ShowAddUserModal">+ Yeni KullanÄ±cÄ±</button>
                    </div>

                    @if (_users.Any())
                    {
                        <div class="table-container-modern">
                            <table class="table-modern">
                                <thead>
                                    <tr>
                                        <th class="sortable" @onclick='() => SortUsers("username")'>
                                            ğŸ‘¤ KullanÄ±cÄ± AdÄ±
                                            <span class="sort-indicator">@(_userSortBy == "username" ? (_userSortAsc ? "â†‘" : "â†“") : "")</span>
                                        </th>
                                        <th class="sortable" @onclick='() => SortUsers("name")'>
                                            ğŸ“ Ad Soyad
                                            <span class="sort-indicator">@(_userSortBy == "name" ? (_userSortAsc ? "â†‘" : "â†“") : "")</span>
                                        </th>
                                        <th>ğŸ“§ Email</th>
                                        <th class="sortable" @onclick='() => SortUsers("admin")'>
                                            ğŸ”‘ Yetki
                                            <span class="sort-indicator">@(_userSortBy == "admin" ? (_userSortAsc ? "â†‘" : "â†“") : "")</span>
                                        </th>
                                        <th class="sortable" @onclick='() => SortUsers("status")'>
                                            âœ… Durum
                                            <span class="sort-indicator">@(_userSortBy == "status" ? (_userSortAsc ? "â†‘" : "â†“") : "")</span>
                                        </th>
                                        <th class="sortable" @onclick='() => SortUsers("login")'>
                                            ğŸ• Son GiriÅŸ
                                            <span class="sort-indicator">@(_userSortBy == "login" ? (_userSortAsc ? "â†‘" : "â†“") : "")</span>
                                        </th>
                                        <th>âš™ï¸ Ä°ÅŸlemler</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var user in GetSortedUsers())
                                    {
                                        <tr>
                                            <td>
                                                <div class="user-cell">
                                                    <strong class="user-name">@user.Username</strong>
                                                    <div class="user-meta">ID: @user.Id</div>
                                                </div>
                                            </td>
                                            <td>@(user.FullName ?? "-")</td>
                                            <td>
                                                @if (!string.IsNullOrEmpty(user.Email))
                                                {
                                                    <a href="mailto:@user.Email" class="email-link">@user.Email</a>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">-</span>
                                                }
                                            </td>
                                            <td>
                                                <span class="role-badge @(user.IsAdmin ? "admin" : "user")">
                                                    @(user.IsAdmin ? "ğŸ‘‘ Admin" : "ğŸ‘¤ User")
                                                </span>
                                            </td>
                                            <td>
                                                @if (user.LockedUntil.HasValue && user.LockedUntil.Value > DateTime.UtcNow)
                                                {
                                                    <span class="status-badge-modern locked">
                                                        <span class="status-icon">ğŸ”’</span>
                                                        <span>Kilitli</span>
                                                        <div class="lock-info">@((int)(user.LockedUntil.Value - DateTime.UtcNow).TotalMinutes) dk kaldÄ±</div>
                                                    </span>
                                                }
                                                else if (user.IsActive)
                                                {
                                                    <span class="status-badge-modern success">
                                                        <span class="status-icon">âœ“</span>
                                                        <span>Aktif</span>
                                                    </span>
                                                }
                                                else
                                                {
                                                    <span class="status-badge-modern error">
                                                        <span class="status-icon">âœ—</span>
                                                        <span>Pasif</span>
                                                    </span>
                                                }
                                            </td>
                                            <td class="date-cell">
                                                @if (user.LastLoginAt.HasValue)
                                                {
                                                    <div class="date-primary">@user.LastLoginAt.Value.ToLocalTime().ToString("dd MMM yyyy")</div>
                                                    <div class="date-secondary">@user.LastLoginAt.Value.ToLocalTime().ToString("HH:mm")</div>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">HiÃ§ giriÅŸ yapmamÄ±ÅŸ</span>
                                                }
                                            </td>
                                            <td>
                                                <div class="action-buttons-modern">
                                                    <button type="button"
                                                            class="btn-action btn-edit"
                                                            @onclick="() => ShowEditUserModal(user)"
                                                            title="DÃ¼zenle">
                                                        âœï¸
                                                    </button>
                                                    @if (user.LockedUntil.HasValue && user.LockedUntil.Value > DateTime.UtcNow)
                                                    {
                                                        <button type="button"
                                                                class="btn-action btn-unlock"
                                                                @onclick="() => HandleUnlockUser(user.Id)"
                                                                title="Kilidi AÃ§">
                                                            ğŸ”“
                                                        </button>
                                                    }
                                                    @if (user.Id != _currentUser?.Id)
                                                    {
                                                        <button type="button"
                                                                class="btn-action btn-delete"
                                                                @onclick="() => HandleDeleteUser(user.Id)"
                                                                title="Sil">
                                                            ğŸ—‘ï¸
                                                        </button>
                                                    }
                                                </div>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state-modern">
                            <div class="empty-icon">ğŸ‘¤</div>
                            <p>HenÃ¼z kullanÄ±cÄ± bulunmuyor.</p>
                        </div>
                    }
                </div>

                @* Add/Edit User Modal *@
                @if (_showUserModal)
                {
                    <div class="modal-overlay" @onclick="CloseUserModal">
                        <div class="modal-content" @onclick:stopPropagation="true">
                            <div class="modal-header">
                                <h3>@(_editingUser == null ? "â• Yeni KullanÄ±cÄ±" : "âœï¸ KullanÄ±cÄ± DÃ¼zenle")</h3>
                                <button type="button" class="modal-close" @onclick="CloseUserModal">âœ•</button>
                            </div>
                            <div class="modal-body">
                                <EditForm Model="@_userFormModel" OnValidSubmit="@(_editingUser == null ? HandleCreateUser : HandleUpdateUser)">
                                    <DataAnnotationsValidator />
                                    <div class="form-group">
                                        <label>KullanÄ±cÄ± AdÄ±</label>
                                        <InputText @bind-Value="_userFormModel.Username" class="form-control" disabled="@(_editingUser != null)" />
                                        <ValidationMessage For="@(() => _userFormModel.Username)" />
                                    </div>
                                    <div class="form-group">
                                        <label>Ad Soyad</label>
                                        <InputText @bind-Value="_userFormModel.FullName" class="form-control" />
                                    </div>
                                    <div class="form-group">
                                        <label>Email</label>
                                        <InputText @bind-Value="_userFormModel.Email" class="form-control" type="email" />
                                    </div>
                                    <div class="form-group">
                                        <label>Åifre @(_editingUser != null ? "(DeÄŸiÅŸtirmek iÃ§in doldurun)" : "")</label>
                                        <InputText @bind-Value="_userFormModel.Password" class="form-control" type="password" />
                                        <small class="form-text">En az 8 karakter, bÃ¼yÃ¼k harf, kÃ¼Ã§Ã¼k harf ve rakam iÃ§ermelidir.</small>
                                    </div>
                                    <div class="form-group inline-checkbox">
                                        <InputCheckbox @bind-Value="_userFormModel.IsAdmin" class="form-checkbox" />
                                        <label>Admin Yetkisi</label>
                                    </div>
                                    <div class="form-group inline-checkbox">
                                        <InputCheckbox @bind-Value="_userFormModel.IsActive" class="form-checkbox" />
                                        <label>Aktif</label>
                                    </div>
                                    @if (!string.IsNullOrEmpty(_userFormError))
                                    {
                                        <div class="alert alert-error">@_userFormError</div>
                                    }
                                    <div class="modal-footer">
                                        <button type="submit" class="btn btn-primary" disabled="@_isSavingUser">
                                            @if (_isSavingUser)
                                            {
                                                <span>Kaydediliyor...</span>
                                            }
                                            else
                                            {
                                                <span>ğŸ’¾ Kaydet</span>
                                            }
                                        </button>
                                        <button type="button" class="btn btn-secondary" @onclick="CloseUserModal">Ä°ptal</button>
                                    </div>
                                </EditForm>
                            </div>
                        </div>
                    </div>
                }
            }
            else if (_activeTab == "logs")
            {
                <div class="settings-form">
                    <h2 class="section-title">ğŸ“‹ Audit Logs</h2>
                    <p class="subsection-description">
                        Sistemdeki tÃ¼m admin iÅŸlemlerini ve giriÅŸ denemelerini gÃ¶rÃ¼ntÃ¼leyebilirsiniz.
                    </p>

                    <div class="form-group">
                        <label>Filtrele</label>
                        <div class="filter-controls">
                            <InputSelect @bind-Value="_logFilterAction" class="form-control" style="width: 200px;">
                                <option value="">TÃ¼m Ä°ÅŸlemler</option>
                                <option value="LoginSuccess">BaÅŸarÄ±lÄ± GiriÅŸ</option>
                                <option value="LoginFailed">BaÅŸarÄ±sÄ±z GiriÅŸ</option>
                                <option value="AccountLocked">Hesap Kilitlendi</option>
                                <option value="CreateUser">KullanÄ±cÄ± OluÅŸturuldu</option>
                                <option value="UpdateUser">KullanÄ±cÄ± GÃ¼ncellendi</option>
                                <option value="DeleteUser">KullanÄ±cÄ± Silindi</option>
                                <option value="UpdateSettings">Ayarlar GÃ¼ncellendi</option>
                            </InputSelect>
                            <button type="button" class="btn btn-secondary" @onclick="LoadAuditLogs">ğŸ” Filtrele</button>
                        </div>
                    </div>

                    @if (_auditLogs.Any())
                    {
                        <div class="table-container-modern">
                            <table class="table-modern">
                                <thead>
                                    <tr>
                                        <th class="sortable" @onclick='() => SortAuditLogs("date")'>
                                            ğŸ“… Tarih
                                            <span class="sort-indicator">@(_auditSortBy == "date" ? (_auditSortAsc ? "â†‘" : "â†“") : "")</span>
                                        </th>
                                        <th class="sortable" @onclick='() => SortAuditLogs("user")'>
                                            ğŸ‘¤ KullanÄ±cÄ±
                                            <span class="sort-indicator">@(_auditSortBy == "user" ? (_auditSortAsc ? "â†‘" : "â†“") : "")</span>
                                        </th>
                                        <th class="sortable" @onclick='() => SortAuditLogs("action")'>
                                            âš¡ Ä°ÅŸlem
                                            <span class="sort-indicator">@(_auditSortBy == "action" ? (_auditSortAsc ? "â†‘" : "â†“") : "")</span>
                                        </th>
                                        <th>ğŸ“ Detay</th>
                                        <th>ğŸŒ IP</th>
                                        <th class="sortable" @onclick='() => SortAuditLogs("status")'>
                                            âœ… Durum
                                            <span class="sort-indicator">@(_auditSortBy == "status" ? (_auditSortAsc ? "â†‘" : "â†“") : "")</span>
                                        </th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var log in GetSortedAuditLogs())
                                    {
                                        <tr>
                                            <td class="date-cell">
                                                <div class="date-primary">@log.Timestamp.ToLocalTime().ToString("dd MMM yyyy")</div>
                                                <div class="date-secondary">@log.Timestamp.ToLocalTime().ToString("HH:mm:ss")</div>
                                            </td>
                                            <td>
                                                <div class="user-cell">
                                                    <span class="user-name">@(log.Username ?? "Sistem")</span>
                                                    @if (!string.IsNullOrEmpty(log.UserId))
                                                    {
                                                        <span class="user-id">ID: @log.UserId</span>
                                                    }
                                                </div>
                                            </td>
                                            <td>
                                                <span class="action-badge action-@log.Action.ToLower().Replace(" ", "-")">@log.Action</span>
                                            </td>
                                            <td class="detail-cell">
                                                <div class="detail-text" title="@log.Details">@(log.Details?.Length > 50 ? log.Details.Substring(0, 50) + "..." : log.Details ?? "-")</div>
                                                @if (!string.IsNullOrEmpty(log.ErrorMessage))
                                                {
                                                    <div class="error-detail">âš ï¸ @log.ErrorMessage</div>
                                                }
                                            </td>
                                            <td>
                                                <span class="ip-badge">@(log.IpAddress ?? "-")</span>
                                            </td>
                                            <td>
                                                <span class="status-badge-modern @(log.Success ? "success" : "error")">
                                                    @if (log.Success)
                                                    {
                                                        <span class="status-icon">âœ“</span>
                                                        <span>BaÅŸarÄ±lÄ±</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="status-icon">âœ—</span>
                                                        <span>BaÅŸarÄ±sÄ±z</span>
                                                    }
                                                </span>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    }
                    else
                    {
                        <div class="empty-state-modern">
                            <div class="empty-icon">ğŸ“‹</div>
                            <p>HenÃ¼z log kaydÄ± bulunmuyor.</p>
                        </div>
                    }
                </div>
            }

            @if (_activeTab == "analytics")
            {
                <div class="tab-content analytics-dashboard">
                    <div class="analytics-header">
                        <div>
                            <h2>ğŸ“Š Analytics Dashboard</h2>
                            <p class="analytics-subtitle">DetaylÄ± konuÅŸma ve kullanÄ±cÄ± istatistikleri</p>
                        </div>
                        <div class="analytics-actions">
                            <button type="button" class="btn btn-secondary" @onclick="ExportAnalytics">ğŸ“¥ Export</button>
                        </div>
                    </div>
                    
                    <div class="analytics-filters">
                        <div class="filter-group">
                            <label>ğŸ“… Zaman AralÄ±ÄŸÄ±</label>
                            <InputSelect @bind-Value="_analyticsPeriod" class="form-control modern-select">
                                <option value="7">Son 7 GÃ¼n</option>
                                <option value="30">Son 30 GÃ¼n</option>
                                <option value="90">Son 90 GÃ¼n</option>
                                <option value="365">Son 1 YÄ±l</option>
                            </InputSelect>
                        </div>
                        <div class="filter-group">
                            <label>ğŸŒ Domain</label>
                            <InputSelect @bind-Value="_analyticsDomain" class="form-control modern-select">
                                <option value="">TÃ¼m Domainler</option>
                                @foreach (var key in _domainKeys)
                                {
                                    <option value="@key.Domain">@key.Domain</option>
                                }
                            </InputSelect>
                        </div>
                        <div class="filter-group">
                            <label>&nbsp;</label>
                            <button type="button" class="btn btn-primary btn-refresh" @onclick="LoadAnalytics">
                                <span class="btn-icon">ğŸ”„</span> Yenile
                            </button>
                        </div>
                    </div>

                    @if (_analyticsStats != null)
                    {
                        <div class="stats-grid-modern">
                            <div class="stat-card-modern stat-primary">
                                <div class="stat-header">
                                    <div class="stat-icon-modern">ğŸ’¬</div>
                                    <div class="stat-trend">
                                        <span class="trend-up">â†—</span>
                                    </div>
                                </div>
                                <div class="stat-body">
                                    <div class="stat-value-modern">@_analyticsStats.TotalConversations.ToString("N0")</div>
                                    <div class="stat-label-modern">Toplam KonuÅŸma</div>
                                    <div class="stat-period">@_analyticsStats.StartDate.ToLocalTime().ToString("dd MMM") - @_analyticsStats.EndDate.ToLocalTime().ToString("dd MMM yyyy")</div>
                                </div>
                            </div>
                            
                            <div class="stat-card-modern stat-success">
                                <div class="stat-header">
                                    <div class="stat-icon-modern">ğŸ“¨</div>
                                    <div class="stat-trend">
                                        <span class="trend-up">â†—</span>
                                    </div>
                                </div>
                                <div class="stat-body">
                                    <div class="stat-value-modern">@_analyticsStats.TotalMessages.ToString("N0")</div>
                                    <div class="stat-label-modern">Toplam Mesaj</div>
                                    <div class="stat-detail">@_analyticsStats.UserMessages kullanÄ±cÄ±, @_analyticsStats.BotMessages bot</div>
                                </div>
                            </div>
                            
                            <div class="stat-card-modern stat-info">
                                <div class="stat-header">
                                    <div class="stat-icon-modern">ğŸ‘¤</div>
                                    <div class="stat-trend">
                                        <span class="trend-up">â†—</span>
                                    </div>
                                </div>
                                <div class="stat-body">
                                    <div class="stat-value-modern">@_analyticsStats.UniqueUsers.ToString("N0")</div>
                                    <div class="stat-label-modern">Benzersiz KullanÄ±cÄ±</div>
                                    <div class="stat-detail">@((_analyticsStats.TotalConversations > 0 ? (double)_analyticsStats.UniqueUsers / _analyticsStats.TotalConversations * 100 : 0).ToString("F1"))% aktiflik oranÄ±</div>
                                </div>
                            </div>
                            
                            <div class="stat-card-modern stat-warning">
                                <div class="stat-header">
                                    <div class="stat-icon-modern">ğŸ“Š</div>
                                    <div class="stat-trend">
                                        <span class="trend-neutral">â†’</span>
                                    </div>
                                </div>
                                <div class="stat-body">
                                    <div class="stat-value-modern">@_analyticsStats.AverageMessagesPerConversation.ToString("F1")</div>
                                    <div class="stat-label-modern">Ortalama Mesaj/KonuÅŸma</div>
                                    <div class="stat-detail">@_analyticsStats.UserMessages kullanÄ±cÄ± mesajÄ±</div>
                                </div>
                            </div>
                            
                            <div class="stat-card-modern stat-secondary">
                                <div class="stat-header">
                                    <div class="stat-icon-modern">âš¡</div>
                                    <div class="stat-trend">
                                        <span class="trend-up">â†—</span>
                                    </div>
                                </div>
                                <div class="stat-body">
                                    <div class="stat-value-modern">@_analyticsStats.UserMessages.ToString("N0")</div>
                                    <div class="stat-label-modern">KullanÄ±cÄ± MesajlarÄ±</div>
                                    <div class="stat-detail">@((_analyticsStats.TotalMessages > 0 ? (double)_analyticsStats.UserMessages / _analyticsStats.TotalMessages * 100 : 0).ToString("F1"))% toplam mesaj</div>
                                </div>
                            </div>
                            
                            <div class="stat-card-modern stat-dark">
                                <div class="stat-header">
                                    <div class="stat-icon-modern">ğŸ¤–</div>
                                    <div class="stat-trend">
                                        <span class="trend-up">â†—</span>
                                    </div>
                                </div>
                                <div class="stat-body">
                                    <div class="stat-value-modern">@_analyticsStats.BotMessages.ToString("N0")</div>
                                    <div class="stat-label-modern">Bot MesajlarÄ±</div>
                                    <div class="stat-detail">@((_analyticsStats.TotalMessages > 0 ? (double)_analyticsStats.BotMessages / _analyticsStats.TotalMessages * 100 : 0).ToString("F1"))% toplam mesaj</div>
                                </div>
                            </div>
                        </div>

                        <div class="analytics-section-modern">
                            <div class="section-header">
                                <h3>ğŸ“ˆ GÃ¼nlÃ¼k KonuÅŸma Trendi</h3>
                                <div class="section-actions">
                                    <span class="section-info">@_dailyStats.Count gÃ¼nlÃ¼k veri</span>
                                </div>
                            </div>
                            @if (_dailyStats.Any())
                            {
                                <div class="chart-container-modern">
                                    <div class="chart-wrapper">
                                        <div class="bar-chart">
                                            @foreach (var stat in _dailyStats.TakeLast(30))
                                            {
                                                var maxCount = _dailyStats.Max(s => s.ConversationCount);
                                                var height = maxCount > 0 ? (stat.ConversationCount * 100.0 / maxCount) : 0;
                                                <div class="bar-item" title="@stat.Date.ToLocalTime().ToString("dd MMM yyyy"): @stat.ConversationCount konuÅŸma">
                                                    <div class="bar-fill" style="height: @($"{height:F1}%")"></div>
                                                    <div class="bar-label">@stat.Date.ToLocalTime().ToString("dd")</div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div class="chart-table-wrapper">
                                        <table class="table-modern">
                                            <thead>
                                                <tr>
                                                    <th class="sortable" @onclick='() => SortDailyStats("date")'>
                                                        Tarih
                                                        <span class="sort-indicator">@(_dailySortBy == "date" ? (_dailySortAsc ? "â†‘" : "â†“") : "")</span>
                                                    </th>
                                                    <th class="sortable" @onclick='() => SortDailyStats("count")'>
                                                        KonuÅŸma SayÄ±sÄ±
                                                        <span class="sort-indicator">@(_dailySortBy == "count" ? (_dailySortAsc ? "â†‘" : "â†“") : "")</span>
                                                    </th>
                                                    <th>Trend</th>
                                                    <th>Grafik</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var stat in GetSortedDailyStats())
                                                {
                                                    var maxCount = _dailyStats.Max(s => s.ConversationCount);
                                                    var percentage = maxCount > 0 ? (stat.ConversationCount * 100.0 / maxCount) : 0;
                                                    var prevStat = _dailyStats.FirstOrDefault(s => s.Date < stat.Date);
                                                    var trend = prevStat != null ? (stat.ConversationCount > prevStat.ConversationCount ? "up" : stat.ConversationCount < prevStat.ConversationCount ? "down" : "neutral") : "neutral";
                                                    var trendValue = prevStat != null ? Math.Abs(stat.ConversationCount - prevStat.ConversationCount) : 0;
                                                    <tr>
                                                        <td class="date-cell">@stat.Date.ToLocalTime().ToString("dd MMM yyyy, dddd")</td>
                                                        <td class="number-cell">
                                                            <strong>@stat.ConversationCount.ToString("N0")</strong>
                                                        </td>
                                                        <td class="trend-cell">
                                                            @if (trend == "up")
                                                            {
                                                                <span class="trend-badge trend-up">â†— +@trendValue</span>
                                                            }
                                                            else if (trend == "down")
                                                            {
                                                                <span class="trend-badge trend-down">â†˜ -@trendValue</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="trend-badge trend-neutral">â†’</span>
                                                            }
                                                        </td>
                                                        <td>
                                                            <div class="progress-bar-modern">
                                                                <div class="progress-fill" style="width: @($"{percentage:F1}%")"></div>
                                                                <span class="progress-text">@($"{percentage:F0}%")</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            }
                        </div>

                        <div class="analytics-section-modern">
                            <div class="section-header">
                                <h3>ğŸ”¥ PopÃ¼ler Sorular</h3>
                                <div class="section-actions">
                                    <InputText @bind-Value="_questionSearch" placeholder="ğŸ” Soru ara..." class="search-input" />
                                </div>
                            </div>
                            @if (_popularQuestions.Any())
                            {
                                <div class="table-container-modern">
                                    <table class="table-modern">
                                        <thead>
                                            <tr>
                                                <th class="sortable" @onclick='() => SortQuestions("question")'>
                                                    Soru
                                                    <span class="sort-indicator">@(_questionSortBy == "question" ? (_questionSortAsc ? "â†‘" : "â†“") : "")</span>
                                                </th>
                                                <th class="sortable number-col" @onclick='() => SortQuestions("count")'>
                                                    Tekrar SayÄ±sÄ±
                                                    <span class="sort-indicator">@(_questionSortBy == "count" ? (_questionSortAsc ? "â†‘" : "â†“") : "")</span>
                                                </th>
                                                <th class="sortable" @onclick='() => SortQuestions("date")'>
                                                    Son Sorulma
                                                    <span class="sort-indicator">@(_questionSortBy == "date" ? (_questionSortAsc ? "â†‘" : "â†“") : "")</span>
                                                </th>
                                                <th>PopÃ¼lerlik</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var question in GetFilteredAndSortedQuestions())
                                            {
                                                var maxCount = _popularQuestions.Max(q => q.Count);
                                                var popularity = maxCount > 0 ? (question.Count * 100.0 / maxCount) : 0;
                                                <tr>
                                                    <td class="question-cell">
                                                        <div class="question-text">@question.Question</div>
                                                    </td>
                                                    <td class="number-cell">
                                                        <span class="badge-count">@question.Count</span>
                                                    </td>
                                                    <td class="date-cell">@question.LastAsked.ToLocalTime().ToString("dd MMM yyyy HH:mm")</td>
                                                    <td>
                                                        <div class="popularity-bar">
                                                            <div class="popularity-fill" style="width: @($"{popularity:F1}%")"></div>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="empty-state-modern">
                                    <div class="empty-icon">ğŸ“­</div>
                                    <p>HenÃ¼z popÃ¼ler soru bulunmuyor.</p>
                                </div>
                            }
                        </div>

                        <div class="analytics-section-modern">
                            <div class="section-header">
                                <h3>â° Saatlik Aktivite DaÄŸÄ±lÄ±mÄ±</h3>
                                <div class="section-actions">
                                    <span class="section-info">24 saatlik analiz</span>
                                </div>
                            </div>
                            @if (_hourlyStats.Any())
                            {
                                <div class="chart-container-modern">
                                    <div class="hourly-chart-wrapper">
                                        <div class="hourly-bars">
                                            @foreach (var stat in _hourlyStats)
                                            {
                                                var maxCount = _hourlyStats.Max(s => s.ConversationCount);
                                                var height = maxCount > 0 ? (stat.ConversationCount * 100.0 / maxCount) : 0;
                                                var isPeak = stat.ConversationCount == maxCount;
                                                <div class="hourly-bar-item @(isPeak ? "peak-hour" : "")" title="@stat.Hour:00 - @stat.ConversationCount konuÅŸma">
                                                    <div class="hourly-bar-fill" style="height: @($"{height:F1}%")"></div>
                                                    <div class="hourly-bar-label">@stat.Hour</div>
                                                    <div class="hourly-bar-value">@stat.ConversationCount</div>
                                                </div>
                                            }
                                        </div>
                                    </div>
                                    <div class="chart-table-wrapper">
                                        <table class="table-modern">
                                            <thead>
                                                <tr>
                                                    <th class="sortable" @onclick='() => SortHourlyStats("hour")'>
                                                        Saat
                                                        <span class="sort-indicator">@(_hourlySortBy == "hour" ? (_hourlySortAsc ? "â†‘" : "â†“") : "")</span>
                                                    </th>
                                                    <th class="sortable number-col" @onclick='() => SortHourlyStats("count")'>
                                                        KonuÅŸma SayÄ±sÄ±
                                                        <span class="sort-indicator">@(_hourlySortBy == "count" ? (_hourlySortAsc ? "â†‘" : "â†“") : "")</span>
                                                    </th>
                                                    <th>YoÄŸunluk</th>
                                                    <th>Grafik</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                @foreach (var stat in GetSortedHourlyStats())
                                                {
                                                    var maxCount = _hourlyStats.Max(s => s.ConversationCount);
                                                    var percentage = maxCount > 0 ? (stat.ConversationCount * 100.0 / maxCount) : 0;
                                                    var intensity = percentage > 75 ? "high" : percentage > 50 ? "medium" : percentage > 25 ? "low" : "very-low";
                                                    <tr>
                                                        <td class="time-cell">
                                                            <span class="time-badge">@stat.Hour:00</span>
                                                            @if (stat.Hour >= 6 && stat.Hour < 12)
                                                            {
                                                                <span class="time-label">Sabah</span>
                                                            }
                                                            else if (stat.Hour >= 12 && stat.Hour < 18)
                                                            {
                                                                <span class="time-label">Ã–ÄŸle</span>
                                                            }
                                                            else if (stat.Hour >= 18 && stat.Hour < 22)
                                                            {
                                                                <span class="time-label">AkÅŸam</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="time-label">Gece</span>
                                                            }
                                                        </td>
                                                        <td class="number-cell">
                                                            <strong>@stat.ConversationCount.ToString("N0")</strong>
                                                        </td>
                                                        <td>
                                                            <span class="intensity-badge intensity-@intensity">
                                                                @(intensity == "high" ? "YÃ¼ksek" : intensity == "medium" ? "Orta" : intensity == "low" ? "DÃ¼ÅŸÃ¼k" : "Ã‡ok DÃ¼ÅŸÃ¼k")
                                                            </span>
                                                        </td>
                                                        <td>
                                                            <div class="progress-bar-modern">
                                                                <div class="progress-fill" style="width: @($"{percentage:F1}%")"></div>
                                                                <span class="progress-text">@($"{percentage:F0}%")</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                }
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            }
                        </div>
                    }
                    else
                    {
                        <div class="empty-state">
                            <p>Analytics yÃ¼kleniyor...</p>
                        </div>
                    }
                </div>
            }
        } <!-- end of _isAuthenticated else -->
    </div>
</div>

@code {
    private AdminSettings _settings = new();
    private bool _isLoading = true;
    private bool _isSaving = false;
    private bool _isTestingConnection = false;
    private bool _showSuccess = false;
    private string _errorMessage = string.Empty;
    private string _connectionStatus = string.Empty;
    private List<string> _availableModels = new();
    private string _activeTab = "llm";
    private string _quickRepliesText = string.Empty;
    private bool _isAuthenticated = false;
    private LoginModel _loginModel = new();
    private string _loginError = string.Empty;
    private List<DomainApiKey> _domainKeys = new();
    private bool _authChecked = false;
    private UserEntity? _currentUser;
    private string _selectedAppearanceDomain = string.Empty;
    private DomainAppearance _domainAppearance = new();
    private string _domainQuickRepliesText = string.Empty;
    private bool _isDomainAppearanceLoading = false;
    private bool _showEditModal = false;
    private string _editingDomain = string.Empty;
    private string _baseUrl = string.Empty;
    
    // User Management
    private List<UserEntity> _users = new();
    private bool _showUserModal = false;
    private UserEntity? _editingUser = null;
    private UserFormModel _userFormModel = new();
    private string _userFormError = string.Empty;
    private bool _isSavingUser = false;
    
    // Audit Logs
    private List<AuditLogEntity> _auditLogs = new();
    private string _logFilterAction = string.Empty;
    
    // Analytics
    private ConversationStats? _analyticsStats;
    private List<PopularQuestion> _popularQuestions = new();
    private List<DailyStats> _dailyStats = new();
    private List<HourlyStats> _hourlyStats = new();
    private int _analyticsPeriod = 30;
    private string _analyticsDomain = string.Empty;
    private string _questionSearch = string.Empty;
    private string _dailySortBy = "date";
    private bool _dailySortAsc = false;
    private string _questionSortBy = "count";
    private bool _questionSortAsc = false;
    private string _hourlySortBy = "hour";
    private bool _hourlySortAsc = true;
    
    // Sorting variables for tables
    private string _auditSortBy = "date";
    private bool _auditSortAsc = false;
    private string _userSortBy = "username";
    private bool _userSortAsc = true;

    protected override async Task OnInitializedAsync()
    {
        _baseUrl = Configuration["BaseUrl"] ?? "https://chatdemo.bridgestone.com.tr";
        await LoadSettings();
        await LoadDomainKeys();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_isAuthenticated)
        {
            try
            {
                // TarayÄ±cÄ± localStorage'dan admin oturum bilgisini oku
                var flag = await JSRuntime.InvokeAsync<string>("localStorage.getItem", "adminAuth");
                if (flag == "1")
                {
                    _isAuthenticated = true;
                }
            }
            catch
            {
                // localStorage kullanÄ±lamÄ±yorsa sessizce devam et
            }
            _authChecked = true;
            StateHasChanged();
        }
        else if (firstRender)
        {
            _authChecked = true;
            StateHasChanged();
        }
    }

    private async Task LoadSettings()
    {
        try
        {
            _isLoading = true;
            _settings = await AdminSettingsService.GetSettingsAsync();
            _quickRepliesText = string.Join("\n", _settings.QuickReplies ?? new List<string>());
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load settings: {ex.Message}";
        }
        finally
        {
            _isLoading = false;
        }
    }

    private async Task LoadDomainKeys()
    {
        try
        {
            _domainKeys = (await DomainApiKeyService.GetAllAsync()).ToList();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load domain keys: {ex.Message}";
        }
    }

    private async Task HandleEditDomain(string domain)
    {
        _editingDomain = domain;
        _showEditModal = true;
        await LoadDomainAppearance(domain);
    }

    private void CloseEditModal()
    {
        _showEditModal = false;
        _editingDomain = string.Empty;
        _domainAppearance = new();
        _domainQuickRepliesText = string.Empty;
    }

    private async Task HandleCopyScript(string domain, string apiKey)
    {
        var script = $@"<script>
    window.BridgestoneChatbotConfig = {{
        baseUrl: '{_baseUrl}',
        apiKey: '{apiKey}',
        domain: '{domain}',
        delay: 2000
    }};
</script>
<script src=""{_baseUrl}/chatbot-embed.js""></script>";

        try
        {
            await JSRuntime.InvokeVoidAsync("navigator.clipboard.writeText", script);
            await JSRuntime.InvokeVoidAsync("alert", "Embed script kopyalandÄ±! HTML sayfanÄ±zÄ±n </body> etiketinden Ã¶nce yapÄ±ÅŸtÄ±rÄ±n.");
        }
        catch
        {
            // Fallback: prompt ile gÃ¶ster
            await JSRuntime.InvokeVoidAsync("prompt", "Embed Script (Ctrl+C ile kopyalayÄ±n):", script);
        }
    }

    private async Task HandleProviderChange()
    {
        _connectionStatus = string.Empty;
        _availableModels.Clear();
        StateHasChanged();
    }

    private async Task HandleTestConnection()
    {
        if (string.IsNullOrWhiteSpace(_settings.OllamaBaseUrl))
        {
            _errorMessage = "Please enter Ollama Base URL first.";
            return;
        }

        try
        {
            _isTestingConnection = true;
            _connectionStatus = string.Empty;
            _errorMessage = string.Empty;
            _availableModels.Clear();
            StateHasChanged();

            var isConnected = await OllamaService.TestConnectionAsync(_settings.OllamaBaseUrl);
            
            if (isConnected)
            {
                _connectionStatus = "success";
                _availableModels = await OllamaService.GetAvailableModelsAsync(_settings.OllamaBaseUrl);
                
                // Auto-select first model if none selected
                if (_availableModels.Any() && string.IsNullOrWhiteSpace(_settings.ModelName))
                {
                    _settings.ModelName = _availableModels.First();
                }
            }
            else
            {
                _connectionStatus = "error";
                _errorMessage = "Failed to connect to Ollama server. Please check the URL and ensure the server is running.";
            }
        }
        catch (Exception ex)
        {
            _connectionStatus = "error";
            _errorMessage = $"Connection error: {ex.Message}";
        }
        finally
        {
            _isTestingConnection = false;
            StateHasChanged();
        }
    }

    private async Task HandleSave()
    {
        try
        {
            _isSaving = true;
            _showSuccess = false;
            _errorMessage = string.Empty;

            // Persist quick replies from multiline input
            _settings.QuickReplies = _quickRepliesText
                .Split('\n', StringSplitOptions.RemoveEmptyEntries)
                .Select(q => q.Trim())
                .Where(q => !string.IsNullOrWhiteSpace(q))
                .Distinct()
                .ToList();

            await AdminSettingsService.SaveSettingsAsync(_settings);
            _showSuccess = true;
            
            await AuditLogService.LogAsync("UpdateSettings", _currentUser?.Id.ToString(), _currentUser?.Username, "AdminSettings", "1", "Updated LLM settings", null, null, true, null);

            // Hide success message after 3 seconds
            await Task.Delay(3000);
            _showSuccess = false;
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to save settings: {ex.Message}";
            await AuditLogService.LogAsync("UpdateSettings", _currentUser?.Id.ToString(), _currentUser?.Username, "AdminSettings", "1", "Failed to update settings", null, null, false, ex.Message);
        }
        finally
        {
            _isSaving = false;
        }
    }

    private async Task SetActiveTab(string tab)
    {
        _activeTab = tab;
        
        if (tab == "domains")
        {
            await LoadDomainKeys();
        }
        else if (tab == "analytics")
        {
            await LoadAnalytics();
        }
        else if (tab == "logs")
        {
            await LoadAuditLogs();
        }
        else if (tab == "users")
        {
            await LoadUsers();
        }
    }

    private async Task LoadAnalytics()
    {
        try
        {
            var startDate = DateTime.UtcNow.AddDays(-_analyticsPeriod);
            var endDate = DateTime.UtcNow;
            var domain = string.IsNullOrWhiteSpace(_analyticsDomain) ? null : _analyticsDomain;

            _analyticsStats = await AnalyticsService.GetConversationStatsAsync(startDate, endDate, domain);
            _popularQuestions = await AnalyticsService.GetPopularQuestionsAsync(20, startDate, endDate);
            _dailyStats = await AnalyticsService.GetDailyStatsAsync(_analyticsPeriod, domain);
            _hourlyStats = await AnalyticsService.GetHourlyStatsAsync(DateTime.UtcNow.Date, domain);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Failed to load analytics: {ex.Message}";
        }
    }

    private void SortDailyStats(string column)
    {
        if (_dailySortBy == column)
        {
            _dailySortAsc = !_dailySortAsc;
        }
        else
        {
            _dailySortBy = column;
            _dailySortAsc = true;
        }
    }

    private List<DailyStats> GetSortedDailyStats()
    {
        var sorted = _dailySortBy switch
        {
            "date" => _dailySortAsc ? _dailyStats.OrderBy(s => s.Date) : _dailyStats.OrderByDescending(s => s.Date),
            "count" => _dailySortAsc ? _dailyStats.OrderBy(s => s.ConversationCount) : _dailyStats.OrderByDescending(s => s.ConversationCount),
            _ => _dailyStats.OrderByDescending(s => s.Date)
        };
        return sorted.ToList();
    }

    private void SortQuestions(string column)
    {
        if (_questionSortBy == column)
        {
            _questionSortAsc = !_questionSortAsc;
        }
        else
        {
            _questionSortBy = column;
            _questionSortAsc = column == "count" ? false : true;
        }
    }

    private List<PopularQuestion> GetFilteredAndSortedQuestions()
    {
        var filtered = string.IsNullOrWhiteSpace(_questionSearch)
            ? _popularQuestions
            : _popularQuestions.Where(q => q.Question.Contains(_questionSearch, StringComparison.OrdinalIgnoreCase)).ToList();

        var sorted = _questionSortBy switch
        {
            "question" => _questionSortAsc ? filtered.OrderBy(q => q.Question) : filtered.OrderByDescending(q => q.Question),
            "count" => _questionSortAsc ? filtered.OrderBy(q => q.Count) : filtered.OrderByDescending(q => q.Count),
            "date" => _questionSortAsc ? filtered.OrderBy(q => q.LastAsked) : filtered.OrderByDescending(q => q.LastAsked),
            _ => filtered.OrderByDescending(q => q.Count)
        };
        return sorted.ToList();
    }

    private void SortHourlyStats(string column)
    {
        if (_hourlySortBy == column)
        {
            _hourlySortAsc = !_hourlySortAsc;
        }
        else
        {
            _hourlySortBy = column;
            _hourlySortAsc = column == "hour" ? true : false;
        }
    }

    private List<HourlyStats> GetSortedHourlyStats()
    {
        var sorted = _hourlySortBy switch
        {
            "hour" => _hourlySortAsc ? _hourlyStats.OrderBy(s => s.Hour) : _hourlyStats.OrderByDescending(s => s.Hour),
            "count" => _hourlySortAsc ? _hourlyStats.OrderBy(s => s.ConversationCount) : _hourlyStats.OrderByDescending(s => s.ConversationCount),
            _ => _hourlyStats.OrderBy(s => s.Hour)
        };
        return sorted.ToList();
    }

    private async Task ExportAnalytics()
    {
        try
        {
            var csv = "Tarih,KonuÅŸma SayÄ±sÄ±\n";
            foreach (var stat in _dailyStats)
            {
                csv += $"{stat.Date:yyyy-MM-dd},{stat.ConversationCount}\n";
            }
            
            var fileName = $"analytics_{DateTime.Now:yyyyMMdd_HHmmss}.csv";
            await JSRuntime.InvokeVoidAsync("downloadFile", fileName, csv, "text/csv");
        }
        catch (Exception ex)
        {
            _errorMessage = $"Export hatasÄ±: {ex.Message}";
        }
    }

    private void SortAuditLogs(string column)
    {
        if (_auditSortBy == column)
        {
            _auditSortAsc = !_auditSortAsc;
        }
        else
        {
            _auditSortBy = column;
            _auditSortAsc = column == "date" ? false : true;
        }
    }

    private List<AuditLogEntity> GetSortedAuditLogs()
    {
        var sorted = _auditSortBy switch
        {
            "date" => _auditSortAsc ? _auditLogs.OrderBy(l => l.Timestamp) : _auditLogs.OrderByDescending(l => l.Timestamp),
            "user" => _auditSortAsc ? _auditLogs.OrderBy(l => l.Username ?? "") : _auditLogs.OrderByDescending(l => l.Username ?? ""),
            "action" => _auditSortAsc ? _auditLogs.OrderBy(l => l.Action) : _auditLogs.OrderByDescending(l => l.Action),
            "status" => _auditSortAsc ? _auditLogs.OrderBy(l => l.Success) : _auditLogs.OrderByDescending(l => l.Success),
            _ => _auditLogs.OrderByDescending(l => l.Timestamp)
        };
        return sorted.ToList();
    }

    private void SortUsers(string column)
    {
        if (_userSortBy == column)
        {
            _userSortAsc = !_userSortAsc;
        }
        else
        {
            _userSortBy = column;
            _userSortAsc = column == "login" ? false : true;
        }
    }

    private List<UserEntity> GetSortedUsers()
    {
        var sorted = _userSortBy switch
        {
            "username" => _userSortAsc ? _users.OrderBy(u => u.Username) : _users.OrderByDescending(u => u.Username),
            "name" => _userSortAsc ? _users.OrderBy(u => u.FullName ?? "") : _users.OrderByDescending(u => u.FullName ?? ""),
            "admin" => _userSortAsc ? _users.OrderBy(u => u.IsAdmin) : _users.OrderByDescending(u => u.IsAdmin),
            "status" => _userSortAsc ? _users.OrderBy(u => u.IsActive) : _users.OrderByDescending(u => u.IsActive),
            "login" => _userSortAsc ? _users.OrderBy(u => u.LastLoginAt ?? DateTime.MinValue) : _users.OrderByDescending(u => u.LastLoginAt ?? DateTime.MinValue),
            _ => _users.OrderBy(u => u.Username)
        };
        return sorted.ToList();
    }

    private async Task HandleReset()
    {
        _settings = new AdminSettings
        {
            LlmProvider = "Ollama",
            ModelName = "hermes3:8b",
            ApiKey = string.Empty,
            OllamaBaseUrl = "http://3.14.208.235:11434",
            SystemPrompt = "You are a helpful assistant for Bridgestone tire and dealer information. When users ask about dealers or tires, you should help them find the information they need.",
            Temperature = 0.7,
            MaxTokens = 2000
        };
        _connectionStatus = string.Empty;
        _availableModels.Clear();
    }

    private async Task HandleResetAppearance()
    {
        _settings.ChatbotName = "Bridgestone Chatbot";
        _settings.ChatbotLogoUrl = string.Empty;
        _settings.PrimaryColor = "#000000";
        _settings.SecondaryColor = "#dc143c";
        _settings.WelcomeMessage = "Merhaba! Bridgestone chatbot'una hoÅŸ geldiniz. Size nasÄ±l yardÄ±mcÄ± olabilirim?\n\nÃ–rnek sorular:\nâ€¢ En yakÄ±n bayi nerede?\nâ€¢ Ä°stanbul KadÄ±kÃ¶y'de bayi var mÄ±?\nâ€¢ 2021 Corolla iÃ§in yaz lastiÄŸi Ã¶ner";
        _settings.ChatbotOnline = true;
        _settings.QuickReplies = new List<string> { "Konumuma yakÄ±n bayileri arÄ±yorum" };
        _quickRepliesText = string.Join("\n", _settings.QuickReplies);
        _settings.GreetingResponse = "Merhaba! Bridgestone chatbot'una hoÅŸ geldiniz. Size nasÄ±l yardÄ±mcÄ± olabilirim?";
        _settings.HowAreYouResponse = "TeÅŸekkÃ¼r ederim, iyiyim! Size nasÄ±l yardÄ±mcÄ± olabilirim? Bridgestone bayileri, lastik Ã¶nerileri veya baÅŸka bir konuda bilgi verebilirim.";
        _settings.WhoAreYouResponse = "Ben Bridgestone'un dijital asistanÄ±yÄ±m. Size yakÄ±n bayileri bulma, araÃ§Ä±nÄ±za uygun lastik Ã¶nerileri sunma ve Bridgestone hakkÄ±nda bilgi verme konularÄ±nda yardÄ±mcÄ± olabilirim. NasÄ±l yardÄ±mcÄ± olabilirim?";
        _settings.WhatCanYouDoResponse = "Size ÅŸu konularda yardÄ±mcÄ± olabilirim:\n\nğŸ“ YakÄ±nÄ±nÄ±zdaki Bridgestone bayilerini bulma\nğŸ™ï¸ Åehir/ilÃ§e bazÄ±nda bayi arama\nğŸš— AraÃ§Ä±nÄ±za uygun lastik Ã¶nerileri\nâ„¹ï¸ Bridgestone hakkÄ±nda genel bilgiler\n\nNasÄ±l yardÄ±mcÄ± olabilirim?";
        _settings.ThanksResponse = "Rica ederim! BaÅŸka bir konuda yardÄ±mcÄ± olabilir miyim?";
        _settings.GoodbyeResponse = "HoÅŸÃ§a kalÄ±n! Ä°yi gÃ¼nler dilerim. Ä°htiyacÄ±nÄ±z olduÄŸunda buradayÄ±m!";
    }

    private async Task HandleLogin()
    {
        _loginError = string.Empty;

        try
        {
            // Database'den kullanÄ±cÄ± doÄŸrulama
            var (user, error) = await UserService.AuthenticateAsync(_loginModel.Username, _loginModel.Password);

            if (user != null && string.IsNullOrEmpty(error))
            {
                _isAuthenticated = true;
                _authChecked = true;
                _currentUser = user;

                try
                {
                    // BaÅŸarÄ±lÄ± giriÅŸten sonra tarayÄ±cÄ±da oturum bilgisini sakla
                    await JSRuntime.InvokeVoidAsync("localStorage.setItem", "adminAuth", "1");
                }
                catch
                {
                    // localStorage hatasÄ± olursa sessiz geÃ§
                }
            }
            else
            {
                _loginError = error ?? "KullanÄ±cÄ± adÄ± veya ÅŸifre hatalÄ±, veya admin yetkiniz bulunmuyor.";
            }
        }
        catch (Exception ex)
        {
            _loginError = $"GiriÅŸ sÄ±rasÄ±nda bir hata oluÅŸtu: {ex.Message}";
        }
    }

    private async Task HandleNewDomainKey()
    {
        try
        {
            var domain = await JSRuntime.InvokeAsync<string>("prompt", "Domain adÄ±nÄ± girin (Ã¶rnek: example.com):");
            if (string.IsNullOrWhiteSpace(domain))
                return;

            await DomainApiKeyService.CreateAsync(domain);
            await LoadDomainKeys();
            await AuditLogService.LogAsync("CreateDomainKey", _currentUser?.Id.ToString(), _currentUser?.Username, "DomainApiKey", domain, $"Created API key for domain: {domain}", null, null, true, null);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Yeni anahtar oluÅŸturulamadÄ±: {ex.Message}";
            await AuditLogService.LogAsync("CreateDomainKey", _currentUser?.Id.ToString(), _currentUser?.Username, "DomainApiKey", null, $"Failed to create API key", null, null, false, ex.Message);
        }
    }

    private async Task HandleDeleteDomainKey(string id)
    {
        try
        {
            var confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Bu API key'i silmek istediÄŸinize emin misiniz?");
            if (!confirm) return;

            await DomainApiKeyService.DeleteAsync(id);
            await LoadDomainKeys();
            await AuditLogService.LogAsync("DeleteDomainKey", _currentUser?.Id.ToString(), _currentUser?.Username, "DomainApiKey", id, $"Deleted API key ID: {id}", null, null, true, null);
        }
        catch (Exception ex)
        {
            _errorMessage = $"Anahtar silinemedi: {ex.Message}";
            await AuditLogService.LogAsync("DeleteDomainKey", _currentUser?.Id.ToString(), _currentUser?.Username, "DomainApiKey", id, $"Failed to delete API key", null, null, false, ex.Message);
        }
    }

    private async Task LoadDomainAppearance(string domain)
    {
        _isDomainAppearanceLoading = true;
        try
        {
            var appearance = await DomainAppearanceService.GetAsync(domain);
            if (appearance != null)
            {
                _domainAppearance = appearance;
            }
            else
            {
                var defaults = await AdminSettingsService.GetSettingsAsync();
                _domainAppearance = new DomainAppearance
                {
                    Domain = domain,
                    ChatbotName = defaults.ChatbotName,
                    ChatbotLogoUrl = defaults.ChatbotLogoUrl,
                    PrimaryColor = defaults.PrimaryColor,
                    SecondaryColor = defaults.SecondaryColor,
                    WelcomeMessage = defaults.WelcomeMessage,
                    ChatbotOnline = defaults.ChatbotOnline,
                    OpenChatOnLoad = defaults.OpenChatOnLoad,
                    QuickReplies = defaults.QuickReplies ?? new List<string>(),
                    GreetingResponse = defaults.GreetingResponse,
                    HowAreYouResponse = defaults.HowAreYouResponse,
                    WhoAreYouResponse = defaults.WhoAreYouResponse,
                    WhatCanYouDoResponse = defaults.WhatCanYouDoResponse,
                    ThanksResponse = defaults.ThanksResponse,
                    GoodbyeResponse = defaults.GoodbyeResponse
                };
            }

            _domainQuickRepliesText = string.Join("\n", _domainAppearance.QuickReplies ?? new List<string>());
        }
        catch (Exception ex)
        {
            _errorMessage = $"Domain gÃ¶rÃ¼nÃ¼mÃ¼ yÃ¼klenemedi: {ex.Message}";
        }
        finally
        {
            _isDomainAppearanceLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSaveDomainAppearance()
    {
        if (string.IsNullOrWhiteSpace(_editingDomain))
        {
            _errorMessage = "LÃ¼tfen bir domain seÃ§in.";
            return;
        }

        try
        {
            _isSaving = true;
            _showSuccess = false;
            _errorMessage = string.Empty;

            _domainAppearance.Domain = _editingDomain;
            _domainAppearance.QuickReplies = _domainQuickRepliesText
                .Split('\n', StringSplitOptions.RemoveEmptyEntries)
                .Select(q => q.Trim())
                .Where(q => !string.IsNullOrWhiteSpace(q))
                .Distinct()
                .ToList();

            await DomainAppearanceService.SaveAsync(_domainAppearance);
            _showSuccess = true;
            
            await AuditLogService.LogAsync("UpdateDomainAppearance", _currentUser?.Id.ToString(), _currentUser?.Username, "DomainAppearance", _editingDomain, $"Updated appearance for domain: {_editingDomain}", null, null, true, null);

            await Task.Delay(1500);
            _showSuccess = false;
            CloseEditModal();
        }
        catch (Exception ex)
        {
            _errorMessage = $"Domain gÃ¶rÃ¼nÃ¼mÃ¼ kaydedilemedi: {ex.Message}";
            await AuditLogService.LogAsync("UpdateDomainAppearance", _currentUser?.Id.ToString(), _currentUser?.Username, "DomainAppearance", _editingDomain, $"Failed to update appearance", null, null, false, ex.Message);
        }
        finally
        {
            _isSaving = false;
        }
    }

    // User Management Methods
    private async Task LoadUsers()
    {
        try
        {
            _users = await UserService.GetAllUsersAsync();
        }
        catch (Exception ex)
        {
            _errorMessage = $"KullanÄ±cÄ±lar yÃ¼klenemedi: {ex.Message}";
        }
    }

    private void ShowAddUserModal()
    {
        _editingUser = null;
        _userFormModel = new UserFormModel { IsAdmin = true, IsActive = true };
        _userFormError = string.Empty;
        _showUserModal = true;
    }

    private void ShowEditUserModal(UserEntity user)
    {
        _editingUser = user;
        _userFormModel = new UserFormModel
        {
            Username = user.Username,
            FullName = user.FullName ?? string.Empty,
            Email = user.Email ?? string.Empty,
            IsAdmin = user.IsAdmin,
            IsActive = user.IsActive
        };
        _userFormError = string.Empty;
        _showUserModal = true;
    }

    private void CloseUserModal()
    {
        _showUserModal = false;
        _editingUser = null;
        _userFormModel = new UserFormModel();
        _userFormError = string.Empty;
    }

    private async Task HandleCreateUser()
    {
        _userFormError = string.Empty;
        _isSavingUser = true;

        try
        {
            if (string.IsNullOrWhiteSpace(_userFormModel.Password))
            {
                _userFormError = "Åifre gereklidir.";
                _isSavingUser = false;
                return;
            }

            var (success, error) = await UserService.CreateUserAsync(
                _userFormModel.Username,
                _userFormModel.Password,
                _userFormModel.IsAdmin,
                string.IsNullOrWhiteSpace(_userFormModel.Email) ? null : _userFormModel.Email,
                string.IsNullOrWhiteSpace(_userFormModel.FullName) ? null : _userFormModel.FullName
            );

            if (success)
            {
                await LoadUsers();
                await AuditLogService.LogAsync("CreateUser", _currentUser?.Id.ToString(), _currentUser?.Username, "User", null, $"Created user: {_userFormModel.Username}", null, null, true, null);
                CloseUserModal();
                _showSuccess = true;
                await Task.Delay(1500);
                _showSuccess = false;
            }
            else
            {
                _userFormError = error ?? "KullanÄ±cÄ± oluÅŸturulamadÄ±.";
            }
        }
        catch (Exception ex)
        {
            _userFormError = $"Hata: {ex.Message}";
        }
        finally
        {
            _isSavingUser = false;
        }
    }

    private async Task HandleUpdateUser()
    {
        if (_editingUser == null) return;

        _userFormError = string.Empty;
        _isSavingUser = true;

        try
        {
            var success = await UserService.UpdateUserAsync(
                _editingUser.Id,
                string.IsNullOrWhiteSpace(_userFormModel.Password) ? null : _userFormModel.Password,
                _userFormModel.IsAdmin,
                string.IsNullOrWhiteSpace(_userFormModel.Email) ? null : _userFormModel.Email,
                string.IsNullOrWhiteSpace(_userFormModel.FullName) ? null : _userFormModel.FullName,
                _userFormModel.IsActive
            );

            if (success)
            {
                await LoadUsers();
                await AuditLogService.LogAsync("UpdateUser", _currentUser?.Id.ToString(), _currentUser?.Username, "User", _editingUser.Id.ToString(), $"Updated user: {_editingUser.Username}", null, null, true, null);
                CloseUserModal();
                _showSuccess = true;
                await Task.Delay(1500);
                _showSuccess = false;
            }
            else
            {
                _userFormError = "KullanÄ±cÄ± gÃ¼ncellenemedi.";
            }
        }
        catch (Exception ex)
        {
            _userFormError = $"Hata: {ex.Message}";
        }
        finally
        {
            _isSavingUser = false;
        }
    }

    private async Task HandleDeleteUser(int id)
    {
        try
        {
            var confirm = await JSRuntime.InvokeAsync<bool>("confirm", "Bu kullanÄ±cÄ±yÄ± silmek istediÄŸinize emin misiniz?");
            if (!confirm) return;

            var success = await UserService.DeleteUserAsync(id);
            if (success)
            {
                await LoadUsers();
                await AuditLogService.LogAsync("DeleteUser", _currentUser?.Id.ToString(), _currentUser?.Username, "User", id.ToString(), $"Deleted user ID: {id}", null, null, true, null);
                _showSuccess = true;
                await Task.Delay(1500);
                _showSuccess = false;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"KullanÄ±cÄ± silinemedi: {ex.Message}";
        }
    }

    private async Task HandleUnlockUser(int id)
    {
        try
        {
            var success = await UserService.UnlockUserAsync(id);
            if (success)
            {
                await LoadUsers();
                await AuditLogService.LogAsync("UnlockUser", _currentUser?.Id.ToString(), _currentUser?.Username, "User", id.ToString(), $"Unlocked user ID: {id}", null, null, true, null);
                _showSuccess = true;
                await Task.Delay(1500);
                _showSuccess = false;
            }
        }
        catch (Exception ex)
        {
            _errorMessage = $"KullanÄ±cÄ± kilidi aÃ§Ä±lamadÄ±: {ex.Message}";
        }
    }

    // Audit Logs Methods
    private async Task LoadAuditLogs()
    {
        try
        {
            _auditLogs = await AuditLogService.GetLogsAsync(
                page: 1,
                pageSize: 100,
                action: string.IsNullOrWhiteSpace(_logFilterAction) ? null : _logFilterAction
            );
        }
        catch (Exception ex)
        {
            _errorMessage = $"Loglar yÃ¼klenemedi: {ex.Message}";
        }
    }

    private class LoginModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
    }

    private class UserFormModel
    {
        public string Username { get; set; } = string.Empty;
        public string Password { get; set; } = string.Empty;
        public string FullName { get; set; } = string.Empty;
        public string Email { get; set; } = string.Empty;
        public bool IsAdmin { get; set; } = true;
        public bool IsActive { get; set; } = true;
    }
}

<style>
    .admin-wrapper {
        height: 100vh;
        padding: 1rem;
        background: #f5f5f5;
        overflow-y: auto;
        overflow-x: hidden;
        position: relative;
    }

    .admin-container {
        max-width: 100%;
        margin: 0 auto;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        margin-bottom: 2rem;
    }

    .admin-header {
        text-align: center;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e0e0e0;
    }

    .login-card {
        max-width: 400px;
        margin: 2rem auto;
        padding: 2rem;
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        text-align: left;
    }

    .login-card h2 {
        margin-top: 0;
        margin-bottom: 0.5rem;
    }

    .admin-header h1 {
        margin: 0;
        color: #333;
        font-size: 2rem;
    }

    .subtitle {
        color: #666;
        margin-top: 0.5rem;
    }

    .loading-container {
        text-align: center;
        padding: 3rem;
    }

    .spinner {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #007bff;
        border-radius: 50%;
        width: 40px;
        height: 40px;
        animation: spin 1s linear infinite;
        margin: 0 auto 1rem;
    }

    @@keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
    }

    .alert {
        padding: 1rem;
        border-radius: 6px;
        margin-bottom: 1.5rem;
    }

    .alert-success {
        background-color: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
    }

    .alert-error {
        background-color: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
    }

    .settings-form {
        margin-bottom: 2rem;
    }

    .form-group {
        margin-bottom: 1.5rem;
    }

    .form-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
    }

    label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #333;
    }

    .form-control {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #ddd;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.3s;
    }

    .form-control:focus {
        outline: none;
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0,123,255,0.1);
    }

    .input-with-button {
        display: flex;
        gap: 0.5rem;
        align-items: flex-start;
    }

    .input-with-button .form-control {
        flex: 1;
    }

    .btn-test {
        padding: 0.75rem 1rem;
        background-color: #28a745;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 0.9rem;
        cursor: pointer;
        white-space: nowrap;
        transition: all 0.3s;
    }

    .btn-test:hover:not(:disabled) {
        background-color: #218838;
    }

    .btn-test:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .connection-status {
        margin-top: 0.5rem;
        padding: 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
    }

    .connection-status.success {
        background-color: #d4edda;
        color: #155724;
    }

    .connection-status.error {
        background-color: #f8d7da;
        color: #721c24;
    }

    .system-prompt {
        font-family: 'Courier New', monospace;
        resize: vertical;
    }

    .form-text {
        display: block;
        margin-top: 0.25rem;
        font-size: 0.875rem;
        color: #666;
    }

    .form-actions {
        display: flex;
        gap: 1rem;
        margin-top: 2rem;
        padding-top: 1rem;
        padding-bottom: 1rem;
        border-top: 1px solid #e0e0e0;
        background: white;
    }

    .btn {
        padding: 0.75rem 1.5rem;
        border: none;
        border-radius: 6px;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s;
    }

    .btn-primary {
        background-color: #007bff;
        color: white;
    }

    .btn-primary:hover:not(:disabled) {
        background-color: #0056b3;
    }

    .btn-primary:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    .btn-secondary {
        background-color: #6c757d;
        color: white;
    }

    .btn-secondary:hover {
        background-color: #545b62;
    }

    .settings-info {
        margin-top: 2rem;
        padding: 1.5rem;
        background-color: #f8f9fa;
        border-radius: 8px;
    }

    .settings-info h3 {
        margin-top: 0;
        margin-bottom: 1rem;
        color: #333;
    }

    .info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
    }

    .info-item {
        padding: 0.5rem;
        background: white;
        border-radius: 4px;
        font-size: 0.9rem;
    }

    .validation-message {
        color: #dc3545;
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    .tabs {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 2rem;
        border-bottom: 2px solid #e0e0e0;
    }

    .tab-button {
        padding: 0.75rem 1.5rem;
        background: transparent;
        border: none;
        border-bottom: 3px solid transparent;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        color: #666;
        transition: all 0.3s;
        margin-bottom: -2px;
    }

    .tab-button:hover {
        color: #333;
        background: rgba(0, 0, 0, 0.05);
    }

    .tab-button.active {
        color: #007bff;
        border-bottom-color: #007bff;
        font-weight: 600;
    }

    .section-title {
        margin-top: 0;
        margin-bottom: 1.5rem;
        color: #333;
        font-size: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e0e0e0;
    }

    .subsection-title {
        margin-top: 2rem;
        margin-bottom: 0.5rem;
        color: #333;
        font-size: 1.25rem;
    }

    .subsection-description {
        color: #666;
        margin-bottom: 1.5rem;
        font-size: 0.9rem;
    }

    .color-input {
        height: 50px;
        padding: 0.25rem;
        cursor: pointer;
    }

    .domain-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 1.5rem;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .domain-table thead {
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
    }

    .domain-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .domain-table td {
        padding: 1rem;
        border-bottom: 1px solid #e0e0e0;
    }

    .domain-table tr:last-child td {
        border-bottom: none;
    }

    .api-key-code {
        background: #f5f5f5;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.85rem;
        font-family: 'Courier New', monospace;
        color: #333;
        word-break: break-all;
    }

    .status-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-badge.active {
        background: #d4edda;
        color: #155724;
    }

    .status-badge.inactive {
        background: #f8d7da;
        color: #721c24;
    }

    .action-buttons {
        display: flex;
        gap: 0.5rem;
    }

    .btn-edit {
        background-color: #17a2b8;
        color: white;
    }

    .btn-edit:hover:not(:disabled) {
        background-color: #138496;
    }

    .btn-info {
        background-color: #6c757d;
        color: white;
    }

    .btn-info:hover:not(:disabled) {
        background-color: #5a6268;
    }

    .btn-sm {
        padding: 0.4rem 0.8rem;
        font-size: 0.875rem;
    }

    .empty-state {
        text-align: center;
        padding: 3rem;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 1.5rem;
    }

    .space-between {
        justify-content: space-between;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 10000;
        padding: 1rem;
    }

    .modal-content {
        background: white;
        border-radius: 12px;
        max-width: 700px;
        width: 100%;
        max-height: 90vh;
        overflow-y: auto;
        box-shadow: 0 10px 40px rgba(0,0,0,0.3);
        display: flex;
        flex-direction: column;
    }

    .modal-header {
        padding: 1.5rem;
        border-bottom: 2px solid #e0e0e0;
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: linear-gradient(135deg, #007bff 0%, #0056b3 100%);
        color: white;
    }

    .modal-header h3 {
        margin: 0;
        font-size: 1.25rem;
    }

    .modal-close {
        background: transparent;
        border: none;
        color: white;
        font-size: 1.5rem;
        cursor: pointer;
        padding: 0;
        width: 32px;
        height: 32px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        transition: all 0.2s;
    }

    .modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
    }

    .modal-body {
        padding: 1.5rem;
        flex: 1;
        overflow-y: auto;
    }

    .modal-footer {
        padding: 1.5rem;
        border-top: 2px solid #e0e0e0;
        display: flex;
        justify-content: flex-end;
        gap: 1rem;
        background: #f8f9fa;
    }

    .inline-checkbox {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
    }

    .inline-checkbox label {
        margin: 0;
        font-weight: 500;
        cursor: pointer;
    }

    .form-checkbox {
        margin-top: 0.25rem;
        cursor: pointer;
    }

    .filter-controls {
        display: flex;
        gap: 1rem;
        align-items: flex-end;
        margin-bottom: 1rem;
    }

    .filter-controls .form-control {
        flex: 0 0 auto;
    }

    /* Analytics Styles */
    .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 1.5rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .stat-icon {
        font-size: 2.5rem;
        line-height: 1;
    }

    .stat-content {
        flex: 1;
    }

    .stat-value {
        font-size: 2rem;
        font-weight: bold;
        color: #007bff;
        line-height: 1.2;
    }

    .stat-label {
        font-size: 0.875rem;
        color: #666;
        margin-top: 0.25rem;
    }

    .analytics-section {
        margin-bottom: 2rem;
    }

    .analytics-section h3 {
        margin-bottom: 1rem;
        color: #333;
    }

    .chart-container {
        background: white;
        border-radius: 8px;
        padding: 1rem;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .progress-bar-container {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
    }

    .progress-bar {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        transition: width 0.3s ease;
    }

    /* Modern Analytics Dashboard Styles */
    .analytics-dashboard {
        padding: 2rem;
    }

    .analytics-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #e9ecef;
    }

    .analytics-header h2 {
        margin: 0;
        font-size: 2rem;
        color: #333;
    }

    .analytics-subtitle {
        margin: 0.5rem 0 0 0;
        color: #666;
        font-size: 0.95rem;
    }

    .analytics-actions {
        display: flex;
        gap: 0.5rem;
    }

    .analytics-filters {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 1rem;
        margin-bottom: 2rem;
        padding: 1.5rem;
        background: #f8f9fa;
        border-radius: 12px;
    }

    .filter-group {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .filter-group label {
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
    }

    .modern-select {
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0.75rem;
        background: white;
        transition: all 0.3s ease;
    }

    .modern-select:focus {
        border-color: #007bff;
        box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        outline: none;
    }

    .btn-refresh {
        display: flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.75rem 1.5rem;
        border-radius: 8px;
        font-weight: 600;
    }

    .btn-icon {
        font-size: 1.1rem;
    }

    .stats-grid-modern {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 1.5rem;
        margin-bottom: 2rem;
    }

    .stat-card-modern {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
        transition: all 0.3s ease;
        border-left: 4px solid;
    }

    .stat-card-modern:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .stat-card-modern.stat-primary {
        border-left-color: #007bff;
    }

    .stat-card-modern.stat-success {
        border-left-color: #28a745;
    }

    .stat-card-modern.stat-info {
        border-left-color: #17a2b8;
    }

    .stat-card-modern.stat-warning {
        border-left-color: #ffc107;
    }

    .stat-card-modern.stat-secondary {
        border-left-color: #6c757d;
    }

    .stat-card-modern.stat-dark {
        border-left-color: #343a40;
    }

    .stat-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .stat-icon-modern {
        font-size: 2.5rem;
        line-height: 1;
    }

    .stat-trend {
        font-size: 1.2rem;
    }

    .trend-up {
        color: #28a745;
    }

    .trend-down {
        color: #dc3545;
    }

    .trend-neutral {
        color: #6c757d;
    }

    .stat-body {
        flex: 1;
    }

    .stat-value-modern {
        font-size: 2.5rem;
        font-weight: 700;
        color: #212529;
        line-height: 1.2;
        margin-bottom: 0.5rem;
    }

    .stat-label-modern {
        font-size: 0.95rem;
        color: #495057;
        font-weight: 600;
        margin-bottom: 0.25rem;
    }

    .stat-period, .stat-detail {
        font-size: 0.85rem;
        color: #6c757d;
        margin-top: 0.5rem;
    }

    .analytics-section-modern {
        background: white;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08);
    }

    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1.5rem;
        padding-bottom: 1rem;
        border-bottom: 1px solid #e9ecef;
    }

    .section-header h3 {
        margin: 0;
        font-size: 1.5rem;
        color: #333;
    }

    .section-actions {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .section-info {
        font-size: 0.85rem;
        color: #6c757d;
    }

    .search-input {
        padding: 0.5rem 1rem;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        font-size: 0.9rem;
        width: 250px;
    }

    .chart-container-modern {
        margin-top: 1rem;
    }

    .chart-wrapper {
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .bar-chart {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        height: 200px;
        gap: 4px;
        padding: 1rem 0;
    }

    .bar-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        position: relative;
        cursor: pointer;
    }

    .bar-fill {
        width: 100%;
        background: linear-gradient(180deg, #007bff, #0056b3);
        border-radius: 4px 4px 0 0;
        transition: all 0.3s ease;
        min-height: 4px;
    }

    .bar-item:hover .bar-fill {
        opacity: 0.8;
    }

    .bar-label {
        margin-top: 0.5rem;
        font-size: 0.75rem;
        color: #6c757d;
        font-weight: 600;
    }

    .hourly-chart-wrapper {
        margin-bottom: 2rem;
        padding: 1rem;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .hourly-bars {
        display: flex;
        align-items: flex-end;
        justify-content: space-between;
        height: 250px;
        gap: 2px;
        padding: 1rem 0;
    }

    .hourly-bar-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        height: 100%;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .hourly-bar-item:hover {
        transform: scaleY(1.05);
    }

    .hourly-bar-item.peak-hour .hourly-bar-fill {
        background: linear-gradient(180deg, #ffc107, #ff9800);
    }

    .hourly-bar-fill {
        width: 100%;
        background: linear-gradient(180deg, #17a2b8, #138496);
        border-radius: 4px 4px 0 0;
        transition: all 0.3s ease;
        min-height: 4px;
    }

    .hourly-bar-label {
        margin-top: 0.5rem;
        font-size: 0.7rem;
        color: #6c757d;
        font-weight: 600;
    }

    .hourly-bar-value {
        font-size: 0.65rem;
        color: #495057;
        margin-top: 0.25rem;
        font-weight: 600;
    }

    .chart-table-wrapper {
        margin-top: 1.5rem;
    }

    .table-modern {
        width: 100%;
        border-collapse: collapse;
        background: white;
    }

    .table-modern thead {
        background: #f8f9fa;
    }

    .table-modern th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #495057;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #dee2e6;
    }

    .table-modern th.sortable {
        cursor: pointer;
        user-select: none;
        transition: background 0.2s ease;
    }

    .table-modern th.sortable:hover {
        background: #e9ecef;
    }

    .sort-indicator {
        margin-left: 0.5rem;
        color: #007bff;
        font-weight: bold;
    }

    .table-modern td {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        color: #495057;
    }

    .table-modern tbody tr {
        transition: background 0.2s ease;
    }

    .table-modern tbody tr:hover {
        background: #f8f9fa;
    }

    .table-modern tbody tr:last-child td {
        border-bottom: none;
    }

    .date-cell {
        font-weight: 500;
        color: #495057;
    }

    .number-cell {
        text-align: right;
        font-weight: 600;
    }

    .number-col {
        text-align: right;
    }

    .question-cell {
        max-width: 400px;
    }

    .question-text {
        word-wrap: break-word;
        line-height: 1.5;
    }

    .time-cell {
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }

    .time-badge {
        background: #e9ecef;
        padding: 0.25rem 0.75rem;
        border-radius: 6px;
        font-weight: 600;
        font-size: 0.9rem;
        color: #495057;
    }

    .time-label {
        font-size: 0.85rem;
        color: #6c757d;
        font-style: italic;
    }

    .trend-cell {
        text-align: center;
    }

    .trend-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .trend-badge.trend-up {
        background: #d4edda;
        color: #155724;
    }

    .trend-badge.trend-down {
        background: #f8d7da;
        color: #721c24;
    }

    .trend-badge.trend-neutral {
        background: #e2e3e5;
        color: #383d41;
    }

    .badge-count {
        display: inline-block;
        background: #007bff;
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 12px;
        font-weight: 600;
        font-size: 0.9rem;
    }

    .intensity-badge {
        display: inline-block;
        padding: 0.35rem 0.85rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .intensity-high {
        background: #f8d7da;
        color: #721c24;
    }

    .intensity-medium {
        background: #fff3cd;
        color: #856404;
    }

    .intensity-low {
        background: #d1ecf1;
        color: #0c5460;
    }

    .intensity-very-low {
        background: #e2e3e5;
        color: #383d41;
    }

    .popularity-bar {
        width: 100%;
        height: 8px;
        background: #e9ecef;
        border-radius: 4px;
        overflow: hidden;
    }

    .popularity-fill {
        height: 100%;
        background: linear-gradient(90deg, #ffc107, #ff9800);
        transition: width 0.3s ease;
    }

    .progress-bar-modern {
        position: relative;
        width: 100%;
        height: 24px;
        background: #e9ecef;
        border-radius: 12px;
        overflow: hidden;
    }

    .progress-fill {
        height: 100%;
        background: linear-gradient(90deg, #007bff, #0056b3);
        transition: width 0.3s ease;
        border-radius: 12px;
    }

    .progress-text {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        font-size: 0.75rem;
        font-weight: 600;
        color: #495057;
        z-index: 1;
    }

    .table-container-modern {
        overflow-x: auto;
        border-radius: 8px;
    }

    .empty-state-modern {
        text-align: center;
        padding: 3rem 1rem;
        color: #6c757d;
    }

    .empty-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        opacity: 0.5;
    }

    .empty-state-modern p {
        font-size: 1.1rem;
        margin: 0;
    }

    @@media (max-width: 768px) {
        .analytics-header {
            flex-direction: column;
            gap: 1rem;
        }

        .analytics-filters {
            grid-template-columns: 1fr;
        }

        .stats-grid-modern {
            grid-template-columns: 1fr;
        }

        .bar-chart, .hourly-bars {
            gap: 2px;
        }

        .bar-label, .hourly-bar-label {
            font-size: 0.65rem;
        }
    }

    /* Enhanced Table Styles for All Tables */
    .domain-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 8px;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .domain-table thead {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .domain-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .domain-table td {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
        color: #495057;
    }

    .domain-table tbody tr {
        transition: background 0.2s ease;
    }

    .domain-table tbody tr:hover {
        background: #f8f9fa;
    }

    .domain-table tbody tr:last-child td {
        border-bottom: none;
    }

    /* Enhanced Status Badges */
    .status-badge-modern {
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        padding: 0.4rem 0.85rem;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .status-badge-modern.success {
        background: #d4edda;
        color: #155724;
    }

    .status-badge-modern.error {
        background: #f8d7da;
        color: #721c24;
    }

    .status-badge-modern.locked {
        background: #fff3cd;
        color: #856404;
    }

    .status-icon {
        font-size: 1rem;
    }

    .lock-info {
        font-size: 0.75rem;
        margin-top: 0.25rem;
        opacity: 0.8;
    }

    /* Enhanced Action Buttons */
    .action-buttons-modern {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .btn-action {
        padding: 0.5rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s ease;
        background: transparent;
    }

    .btn-action.btn-edit {
        color: #007bff;
    }

    .btn-action.btn-edit:hover {
        background: #e7f3ff;
        transform: scale(1.1);
    }

    .btn-action.btn-unlock {
        color: #ffc107;
    }

    .btn-action.btn-unlock:hover {
        background: #fff8e1;
        transform: scale(1.1);
    }

    .btn-action.btn-delete {
        color: #dc3545;
    }

    .btn-action.btn-delete:hover {
        background: #ffeaea;
        transform: scale(1.1);
    }

    /* Enhanced User Cell */
    .user-cell {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
    }

    .user-name {
        font-weight: 600;
        color: #212529;
    }

    .user-id, .user-meta {
        font-size: 0.75rem;
        color: #6c757d;
    }

    /* Enhanced Date Cell */
    .date-primary {
        font-weight: 600;
        color: #212529;
    }

    .date-secondary {
        font-size: 0.85rem;
        color: #6c757d;
    }

    /* Enhanced Detail Cell */
    .detail-cell {
        max-width: 300px;
    }

    .detail-text {
        word-wrap: break-word;
        line-height: 1.5;
    }

    .error-detail {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #dc3545;
        font-style: italic;
    }

    /* Enhanced Badges */
    .action-badge {
        display: inline-block;
        padding: 0.35rem 0.85rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
        background: #e9ecef;
        color: #495057;
    }

    .ip-badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 8px;
        background: #f8f9fa;
        color: #495057;
        font-family: monospace;
        font-size: 0.85rem;
    }

    .role-badge {
        display: inline-block;
        padding: 0.35rem 0.85rem;
        border-radius: 12px;
        font-size: 0.85rem;
        font-weight: 600;
    }

    .role-badge.admin {
        background: #fff3cd;
        color: #856404;
    }

    .role-badge.user {
        background: #d1ecf1;
        color: #0c5460;
    }

    .email-link {
        color: #007bff;
        text-decoration: none;
        transition: color 0.2s ease;
    }

    .email-link:hover {
        color: #0056b3;
        text-decoration: underline;
    }

    .text-muted {
        color: #6c757d;
        font-style: italic;
    }

    /* Enhanced Domain Table */
    .api-key-code {
        background: #f8f9fa;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-family: 'Courier New', monospace;
        font-size: 0.85rem;
        color: #495057;
        border: 1px solid #dee2e6;
    }
</style>
