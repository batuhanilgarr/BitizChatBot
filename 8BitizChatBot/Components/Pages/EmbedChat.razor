@page "/embed"
@namespace BitizChatBot.Components.Pages
@using BitizChatBot.Components
@using BitizChatBot.Components.Layout
@using BitizChatBot.Services
@using Microsoft.AspNetCore.Components.Web
@inject IDomainApiKeyService DomainApiKeyService
@inject NavigationManager NavManager
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime
@inject IHttpContextAccessor HttpContextAccessor
@inject ILogger<EmbedChat> Logger
@rendermode RenderMode.InteractiveServer
@layout EmbedLayout

@if (_isAuthorized)
{
    <ChatWidget ForceOpen="true" />
}
else if (_checked)
{
    <div style="
        width:100%;
        height:100vh;
        max-height:100%;
        display:flex;
        flex-direction:column;
        border: 3px solid #dc143c;
        border-radius:16px;
        overflow:hidden;
        box-shadow:0 8px 32px rgba(0,0,0,0.25);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background:#f5f5f5;">
        <div style="
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color:white;
            padding:0.9rem 1rem;
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-bottom:3px solid #dc143c;
            font-weight:600;">
            <span>Bridgestone Chatbot</span>
            <span style="font-size:1rem; opacity:0.8;"><i class="fa-solid fa-lock"></i></span>
        </div>
        <div style="
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:1.5rem;
            text-align:center;
            color:#333;
            background:white;">
            <div>
                <div style="font-size:1rem; font-weight:600; margin-bottom:0.5rem; color:#b33a3a;">API Anahtarı Geçersiz</div>
                <div style="font-size:0.95rem;">Bu alan için geçerli bir API anahtarı bulunamadı.<br />Lütfen site yöneticinizle iletişime geçin.</div>
            </div>
        </div>
    </div>
}

@code
{
    private bool _isAuthorized = false;
    private bool _checked = false;

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(NavManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var apiKey = query.Get("apiKey") ?? string.Empty;

        Logger.LogInformation("EmbedChat.OnInitializedAsync: URI={Uri}, ApiKey={ApiKey}", NavManager.Uri, apiKey.Length > 10 ? apiKey.Substring(0, 10) + "..." : apiKey);

        // Priority 1: Query string'den domain al (iframe embed script'inden gelir, güvenilir)
        // Blazor InteractiveServer modunda WebSocket bağlantısı sonrası Origin header'ı
        // Blazor server'ın kendi URL'sini gösterir, bu yüzden query string'e öncelik vermeliyiz
        string? domain = query.Get("domain");
        Logger.LogInformation("EmbedChat: Domain from query string={Domain}", domain ?? "null");

        var httpContext = HttpContextAccessor.HttpContext;
        var origin = httpContext?.Request.Headers.Origin.ToString();
        var referer = httpContext?.Request.Headers.Referer.ToString();

        Logger.LogInformation("EmbedChat: Origin={Origin}, Referer={Referer}", origin ?? "null", referer ?? "null");

        // Priority 2: Eğer query string'de domain yoksa, Origin/Referer'dan al
        // Ancak Origin'in Blazor server'ın kendi URL'si olmadığından emin ol
        if (string.IsNullOrWhiteSpace(domain))
        {
            string? originOrReferer = !string.IsNullOrWhiteSpace(origin) ? origin : referer;
            if (!string.IsNullOrWhiteSpace(originOrReferer) && Uri.TryCreate(originOrReferer, UriKind.Absolute, out var originUri))
            {
                var originHost = originUri.Host;
                var currentHost = uri.Host;
                
                // Origin'in Blazor server'ın kendi URL'si olmadığından emin ol
                if (originHost != currentHost)
                {
                    domain = originHost;
                    Logger.LogInformation("EmbedChat: Domain from Origin/Referer={Domain} (different from server host)", domain);
                }
                else
                {
                    Logger.LogInformation("EmbedChat: Origin matches server host, ignoring Origin header");
                }
            }
        }

        // Priority 3: Referer'dan al (eğer query string ve Origin'de yoksa)
        if (string.IsNullOrWhiteSpace(domain) && !string.IsNullOrWhiteSpace(referer))
        {
            if (Uri.TryCreate(referer, UriKind.Absolute, out var refererUri))
            {
                var refererHost = refererUri.Host;
                var currentHost = uri.Host;
                
                // Referer'ın Blazor server'ın kendi URL'si olmadığından emin ol
                if (refererHost != currentHost)
                {
                    domain = refererHost;
                    Logger.LogInformation("EmbedChat: Domain from Referer URI={Domain} (different from server host)", domain);
                }
            }
        }

        // Priority 4: Son fallback - current URI'den (sadece test amaçlı)
        if (string.IsNullOrWhiteSpace(domain))
        {
            domain = uri.Host;
            Logger.LogInformation("EmbedChat: Domain from current URI={Domain} (fallback)", domain);
        }

        Logger.LogInformation("EmbedChat: Final domain={Domain}, ApiKey={ApiKey}", domain ?? "null", apiKey.Length > 10 ? apiKey.Substring(0, 10) + "..." : apiKey);

        _isAuthorized = await DomainApiKeyService.ValidateAsync(domain ?? string.Empty, apiKey);
        Logger.LogInformation("EmbedChat: Validation result={IsAuthorized}", _isAuthorized);
        _checked = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            Logger.LogInformation("EmbedChat: OnAfterRenderAsync - Checking FontAwesome loading");
            
            // Ensure FontAwesome is loaded in iframe - check and load if missing
            await JSRuntime.InvokeVoidAsync("eval", @"
                (function() {
                    console.log('[FontAwesome] Starting FontAwesome check and load...');
                    
                    function checkFontLoaded() {
                        var testIcon = document.createElement('i');
                        testIcon.className = 'fa-solid fa-location-dot';
                        testIcon.style.position = 'absolute';
                        testIcon.style.visibility = 'hidden';
                        testIcon.style.fontSize = '16px';
                        document.body.appendChild(testIcon);
                        
                        try {
                            var computed = window.getComputedStyle(testIcon, ':before');
                            var fontFamily = computed.getPropertyValue('font-family');
                            var content = computed.getPropertyValue('content');
                            var width = computed.getPropertyValue('width');
                            
                            console.log('[FontAwesome] Font check:', {
                                fontFamily: fontFamily,
                                content: content,
                                width: width,
                                hasFontAwesome: fontFamily && fontFamily.includes('Font Awesome')
                            });
                            
                            document.body.removeChild(testIcon);
                            
                            if (fontFamily && fontFamily.includes('Font Awesome') && content && content !== 'none') {
                                console.log('[FontAwesome] ✓ Fonts are loaded and working!');
                                return true;
                            } else {
                                console.warn('[FontAwesome] ✗ Fonts are NOT loaded properly');
                                return false;
                            }
                        } catch(e) {
                            console.error('[FontAwesome] Error checking font:', e);
                            document.body.removeChild(testIcon);
                            return false;
                        }
                    }
                    
                    function loadFontAwesome() {
                        console.log('[FontAwesome] loadFontAwesome called');
                        
                        var existing = document.querySelector('link[href*=""font-awesome""]') || 
                                      document.querySelector('link[href*=""fontawesome""]') ||
                                      document.querySelector('link[href*=""fortawesome""]');
                        
                        console.log('[FontAwesome] Existing link found:', !!existing);
                        
                        if (existing) {
                            console.log('[FontAwesome] Existing link href:', existing.href);
                            // Wait a bit for fonts to load, then check
                            setTimeout(function() {
                                if (!checkFontLoaded()) {
                                    console.warn('[FontAwesome] CSS loaded but fonts not working, trying to reload...');
                                    loadFontAwesomeCSS();
                                }
                            }, 500);
                            return;
                        }
                        
                        loadFontAwesomeCSS();
                    }
                    
                    function loadFontAwesomeCSS() {
                        console.log('[FontAwesome] Loading FontAwesome CSS from cdnjs...');
                        
                        // Use cdnjs - more reliable for font files
                        var link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css';
                        link.integrity = 'sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==';
                        link.crossOrigin = 'anonymous';
                        link.referrerPolicy = 'no-referrer';
                        
                        link.onload = function() {
                            console.log('[FontAwesome] ✓ CSS loaded from cdnjs');
                            console.log('[FontAwesome] Checking font files...');
                            
                            // Preload font files to ensure they load
                            var fontUrls = [
                                'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/webfonts/fa-solid-900.woff2',
                                'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/webfonts/fa-solid-900.woff'
                            ];
                            
                            fontUrls.forEach(function(fontUrl) {
                                var fontLink = document.createElement('link');
                                fontLink.rel = 'preload';
                                fontLink.as = 'font';
                                fontLink.type = 'font/woff2';
                                fontLink.crossOrigin = 'anonymous';
                                fontLink.href = fontUrl;
                                document.head.appendChild(fontLink);
                                console.log('[FontAwesome] Preloading font:', fontUrl);
                            });
                            
                            // Check if fonts are loaded after CSS loads
                            setTimeout(function() {
                                if (checkFontLoaded()) {
                                    console.log('[FontAwesome] ✓ All fonts loaded successfully!');
                                    
                                    // Test actual icon rendering
                                    var testIcon = document.createElement('i');
                                    testIcon.className = 'fa-solid fa-location-dot';
                                    testIcon.style.position = 'absolute';
                                    testIcon.style.visibility = 'hidden';
                                    testIcon.style.fontSize = '20px';
                                    document.body.appendChild(testIcon);
                                    
                                    setTimeout(function() {
                                        var computed = window.getComputedStyle(testIcon, ':before');
                                        var content = computed.getPropertyValue('content');
                                        var fontFamily = computed.getPropertyValue('font-family');
                                        var width = computed.getPropertyValue('width');
                                        
                                        console.log('[FontAwesome] Icon render test:', {
                                            content: content,
                                            fontFamily: fontFamily,
                                            width: width,
                                            hasContent: content && content !== 'none' && content !== '',
                                            hasFontFamily: fontFamily && fontFamily.includes('Font Awesome')
                                        });
                                        
                                        // Check if icon is actually visible
                                        var iconElements = document.querySelectorAll('.fa-solid, .fa-regular, .fa-brands, i.fa-solid, i.fa-regular, i.fa-brands');
                                        console.log('[FontAwesome] Found ' + iconElements.length + ' icon elements in DOM');
                                        
                                        if (iconElements.length > 0) {
                                            var firstIcon = iconElements[0];
                                            var firstIconComputed = window.getComputedStyle(firstIcon, ':before');
                                            console.log('[FontAwesome] First icon computed style:', {
                                                content: firstIconComputed.getPropertyValue('content'),
                                                fontFamily: firstIconComputed.getPropertyValue('font-family'),
                                                display: firstIconComputed.getPropertyValue('display'),
                                                width: firstIconComputed.getPropertyValue('width'),
                                                height: firstIconComputed.getPropertyValue('height')
                                            });
                                        }
                                        
                                        document.body.removeChild(testIcon);
                                    }, 100);
                                    
                                    var event = new Event('fontawesome-loaded');
                                    document.dispatchEvent(event);
                                } else {
                                    console.error('[FontAwesome] ✗ CSS loaded but fonts failed to load');
                                    console.log('[FontAwesome] Network tab - check if font files (woff2, woff) are loading');
                                    // List all stylesheets
                                    var stylesheets = Array.from(document.styleSheets);
                                    stylesheets.forEach(function(sheet, index) {
                                        try {
                                            console.log('[FontAwesome] Stylesheet ' + index + ':', sheet.href);
                                            if (sheet.href && sheet.href.includes('fontawesome')) {
                                                console.log('[FontAwesome] Found FontAwesome stylesheet:', sheet.href);
                                                // Try to access font-face rules
                                                try {
                                                    var rules = sheet.cssRules || sheet.rules;
                                                    if (rules) {
                                                        var fontFaceCount = 0;
                                                        for (var i = 0; i < rules.length; i++) {
                                                            if (rules[i].type === CSSRule.FONT_FACE_RULE) {
                                                                fontFaceCount++;
                                                                var fontFace = rules[i];
                                                                console.log('[FontAwesome] Font-face rule ' + fontFaceCount + ':', {
                                                                    fontFamily: fontFace.style.fontFamily,
                                                                    src: fontFace.style.src
                                                                });
                                                            }
                                                        }
                                                        console.log('[FontAwesome] Total font-face rules found:', fontFaceCount);
                                                    }
                                                } catch(e) {
                                                    console.warn('[FontAwesome] Cannot access stylesheet rules (CORS):', e.message);
                                                }
                                            }
                                        } catch(e) {
                                            console.warn('[FontAwesome] Error accessing stylesheet:', e);
                                        }
                                    });
                                }
                            }, 1500);
                        };
                        
                        link.onerror = function(e) {
                            console.error('[FontAwesome] ✗ cdnjs failed:', e);
                        };
                        
                        document.head.insertBefore(link, document.head.firstChild);
                    }
                    
                    // Try immediately
                    loadFontAwesome();
                    
                    // Also try after delays
                    setTimeout(loadFontAwesome, 100);
                    setTimeout(loadFontAwesome, 500);
                    setTimeout(loadFontAwesome, 1000);
                    setTimeout(function() {
                        console.log('[FontAwesome] Final check after 2 seconds...');
                        checkFontLoaded();
                    }, 2000);
                })();
            ");
        }
        await Task.CompletedTask;
    }

    private string GetCssUrl()
    {
        var baseUrl = Configuration["BaseUrl"] ?? NavManager.BaseUri.TrimEnd('/');
        return $"{baseUrl}/chatbot-widget.css";
    }
}


