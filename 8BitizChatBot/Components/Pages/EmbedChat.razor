@page "/embed"
@namespace BitizChatBot.Components.Pages
@using BitizChatBot.Components
@using BitizChatBot.Components.Layout
@using BitizChatBot.Services
@using Microsoft.AspNetCore.Components.Web
@inject IDomainApiKeyService DomainApiKeyService
@inject NavigationManager NavManager
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime
@rendermode RenderMode.InteractiveServer
@layout EmbedLayout

<HeadContent>
    <link rel="stylesheet" href="@GetCssUrl()" />
</HeadContent>

@if (_isAuthorized)
{
    <ChatWidget />
}
else if (_checked)
{
    <div style="
        width:100%;
        height:100vh;
        max-height:100%;
        display:flex;
        flex-direction:column;
        border: 3px solid #dc143c;
        border-radius:16px;
        overflow:hidden;
        box-shadow:0 8px 32px rgba(0,0,0,0.25);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background:#f5f5f5;">
        <div style="
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color:white;
            padding:0.9rem 1rem;
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-bottom:3px solid #dc143c;
            font-weight:600;">
            <span>Bridgestone Chatbot</span>
            <span style="font-size:1rem; opacity:0.8;">üîí</span>
        </div>
        <div style="
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:1.5rem;
            text-align:center;
            color:#333;
            background:white;">
            <div>
                <div style="font-size:1rem; font-weight:600; margin-bottom:0.5rem; color:#b33a3a;">API Anahtarƒ± Ge√ßersiz</div>
                <div style="font-size:0.95rem;">Bu alan i√ßin ge√ßerli bir API anahtarƒ± bulunamadƒ±.<br />L√ºtfen site y√∂neticinizle ileti≈üime ge√ßin.</div>
            </div>
        </div>
    </div>
}

@code
{
    private bool _isAuthorized = false;
    private bool _checked = false;

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(NavManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var apiKey = query.Get("apiKey") ?? string.Empty;
        var domain = query.Get("domain") ?? uri.Host;

        _isAuthorized = await DomainApiKeyService.ValidateAsync(domain, apiKey);
        _checked = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // CSS'i JavaScript ile dinamik olarak y√ºkle (host sayfa CSS'lerinden sonra)
            // CSS y√ºklendikten sonra tekrar render et
            var cssUrl = GetCssUrl();
            await JSRuntime.InvokeVoidAsync("eval", $@"
                (function() {{
                    if (!document.getElementById('chatbot-widget-css')) {{
                        var link = document.createElement('link');
                        link.id = 'chatbot-widget-css';
                        link.rel = 'stylesheet';
                        link.type = 'text/css';
                        link.href = '{cssUrl}';
                        link.media = 'all';
                        // CSS y√ºklendikten sonra callback
                        link.onload = function() {{
                            // CSS y√ºklendi, t√ºm stilleri zorla uygula
                            var style = document.createElement('style');
                            style.textContent = '/* Force CSS application */';
                            document.head.appendChild(style);
                        }};
                        // CSS'i head'in en sonuna ekle (en y√ºksek √∂ncelik)
                        document.head.appendChild(link);
                    }}
                }})();
            ");
        }
    }

    private string GetCssUrl()
    {
        var baseUrl = Configuration["BaseUrl"] ?? NavManager.BaseUri.TrimEnd('/');
        return $"{baseUrl}/chatbot-widget.css";
    }
}


