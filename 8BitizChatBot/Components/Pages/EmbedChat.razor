@page "/embed"
@namespace BitizChatBot.Components.Pages
@using BitizChatBot.Components
@using BitizChatBot.Components.Layout
@using BitizChatBot.Services
@using Microsoft.AspNetCore.Components.Web
@inject IDomainApiKeyService DomainApiKeyService
@inject NavigationManager NavManager
@inject IConfiguration Configuration
@inject IJSRuntime JSRuntime
@inject IHttpContextAccessor HttpContextAccessor
@inject ILogger<EmbedChat> Logger
@rendermode RenderMode.InteractiveServer
@layout EmbedLayout

@if (_isAuthorized)
{
    <ChatWidget ForceOpen="true" />
}
else if (_checked)
{
    <div style="
        width:100%;
        height:100vh;
        max-height:100%;
        display:flex;
        flex-direction:column;
        border: 3px solid #dc143c;
        border-radius:16px;
        overflow:hidden;
        box-shadow:0 8px 32px rgba(0,0,0,0.25);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background:#f5f5f5;">
        <div style="
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color:white;
            padding:0.9rem 1rem;
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-bottom:3px solid #dc143c;
            font-weight:600;">
            <span>Bridgestone Chatbot</span>
            <span style="font-size:1rem; opacity:0.8;"><i class="fa-solid fa-lock"></i></span>
        </div>
        <div style="
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:1.5rem;
            text-align:center;
            color:#333;
            background:white;">
            <div>
                <div style="font-size:1rem; font-weight:600; margin-bottom:0.5rem; color:#b33a3a;">API Anahtarı Geçersiz</div>
                <div style="font-size:0.95rem;">Bu alan için geçerli bir API anahtarı bulunamadı.<br />Lütfen site yöneticinizle iletişime geçin.</div>
            </div>
        </div>
    </div>
}

@code
{
    private bool _isAuthorized = false;
    private bool _checked = false;

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(NavManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var apiKey = query.Get("apiKey") ?? string.Empty;

        Logger.LogInformation("EmbedChat.OnInitializedAsync: URI={Uri}, ApiKey={ApiKey}", NavManager.Uri, apiKey.Length > 10 ? apiKey.Substring(0, 10) + "..." : apiKey);

        // Priority 1: Query string'den domain al (iframe embed script'inden gelir, güvenilir)
        // Blazor InteractiveServer modunda WebSocket bağlantısı sonrası Origin header'ı
        // Blazor server'ın kendi URL'sini gösterir, bu yüzden query string'e öncelik vermeliyiz
        string? domain = query.Get("domain");
        Logger.LogInformation("EmbedChat: Domain from query string={Domain}", domain ?? "null");

        var httpContext = HttpContextAccessor.HttpContext;
        var origin = httpContext?.Request.Headers.Origin.ToString();
        var referer = httpContext?.Request.Headers.Referer.ToString();

        Logger.LogInformation("EmbedChat: Origin={Origin}, Referer={Referer}", origin ?? "null", referer ?? "null");

        // Priority 2: Eğer query string'de domain yoksa, Origin/Referer'dan al
        // Ancak Origin'in Blazor server'ın kendi URL'si olmadığından emin ol
        if (string.IsNullOrWhiteSpace(domain))
        {
            string? originOrReferer = !string.IsNullOrWhiteSpace(origin) ? origin : referer;
            if (!string.IsNullOrWhiteSpace(originOrReferer) && Uri.TryCreate(originOrReferer, UriKind.Absolute, out var originUri))
            {
                var originHost = originUri.Host;
                var currentHost = uri.Host;
                
                // Origin'in Blazor server'ın kendi URL'si olmadığından emin ol
                if (originHost != currentHost)
                {
                    domain = originHost;
                    Logger.LogInformation("EmbedChat: Domain from Origin/Referer={Domain} (different from server host)", domain);
                }
                else
                {
                    Logger.LogInformation("EmbedChat: Origin matches server host, ignoring Origin header");
                }
            }
        }

        // Priority 3: Referer'dan al (eğer query string ve Origin'de yoksa)
        if (string.IsNullOrWhiteSpace(domain) && !string.IsNullOrWhiteSpace(referer))
        {
            if (Uri.TryCreate(referer, UriKind.Absolute, out var refererUri))
            {
                var refererHost = refererUri.Host;
                var currentHost = uri.Host;
                
                // Referer'ın Blazor server'ın kendi URL'si olmadığından emin ol
                if (refererHost != currentHost)
                {
                    domain = refererHost;
                    Logger.LogInformation("EmbedChat: Domain from Referer URI={Domain} (different from server host)", domain);
                }
            }
        }

        // Priority 4: Son fallback - current URI'den (sadece test amaçlı)
        if (string.IsNullOrWhiteSpace(domain))
        {
            domain = uri.Host;
            Logger.LogInformation("EmbedChat: Domain from current URI={Domain} (fallback)", domain);
        }

        Logger.LogInformation("EmbedChat: Final domain={Domain}, ApiKey={ApiKey}", domain ?? "null", apiKey.Length > 10 ? apiKey.Substring(0, 10) + "..." : apiKey);

        _isAuthorized = await DomainApiKeyService.ValidateAsync(domain ?? string.Empty, apiKey);
        Logger.LogInformation("EmbedChat: Validation result={IsAuthorized}", _isAuthorized);
        _checked = true;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        await Task.CompletedTask;
    }

    private string GetCssUrl()
    {
        var baseUrl = Configuration["BaseUrl"] ?? NavManager.BaseUri.TrimEnd('/');
        return $"{baseUrl}/chatbot-widget.css";
    }
}


