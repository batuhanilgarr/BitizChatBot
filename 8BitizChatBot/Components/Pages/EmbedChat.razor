@page "/embed"
@namespace BitizChatBot.Components.Pages
@using BitizChatBot.Components
@using BitizChatBot.Components.Layout
@using BitizChatBot.Services
@inject IDomainApiKeyService DomainApiKeyService
@inject NavigationManager NavManager
@rendermode RenderMode.InteractiveServer
@layout EmbedLayout

@if (_isAuthorized)
{
    <ChatWidget />
}
else if (_checked)
{
    <div style="
        width:100%;
        height:100vh;
        max-height:100%;
        display:flex;
        flex-direction:column;
        border: 3px solid #dc143c;
        border-radius:16px;
        overflow:hidden;
        box-shadow:0 8px 32px rgba(0,0,0,0.25);
        font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        background:#f5f5f5;">
        <div style="
            background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
            color:white;
            padding:0.9rem 1rem;
            display:flex;
            align-items:center;
            justify-content:space-between;
            border-bottom:3px solid #dc143c;
            font-weight:600;">
            <span>Bridgestone Chatbot</span>
            <span style="font-size:1rem; opacity:0.8;">ðŸ”’</span>
        </div>
        <div style="
            flex:1;
            display:flex;
            align-items:center;
            justify-content:center;
            padding:1.5rem;
            text-align:center;
            color:#333;
            background:white;">
            <div>
                <div style="font-size:1rem; font-weight:600; margin-bottom:0.5rem; color:#b33a3a;">API AnahtarÄ± GeÃ§ersiz</div>
                <div style="font-size:0.95rem;">Bu alan iÃ§in geÃ§erli bir API anahtarÄ± bulunamadÄ±.<br />LÃ¼tfen site yÃ¶neticinizle iletiÅŸime geÃ§in.</div>
            </div>
        </div>
    </div>
}

@code
{
    private bool _isAuthorized = false;
    private bool _checked = false;

    protected override async Task OnInitializedAsync()
    {
        var uri = new Uri(NavManager.Uri);
        var query = System.Web.HttpUtility.ParseQueryString(uri.Query);
        var apiKey = query.Get("apiKey") ?? string.Empty;
        var domain = query.Get("domain") ?? uri.Host;

        _isAuthorized = await DomainApiKeyService.ValidateAsync(domain, apiKey);
        _checked = true;
    }
}


