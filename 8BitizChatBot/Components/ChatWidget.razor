@namespace BitizChatBot.Components
@using BitizChatBot.Models
@using BitizChatBot.Services
@using Microsoft.AspNetCore.Components.Web
@inject IChatOrchestrationService ChatService
@inject IAdminSettingsService AdminSettingsService
@inject IDomainAppearanceService DomainAppearanceService
@inject NavigationManager NavManager
@inject IJSRuntime JSRuntime
@inject ILogger<ChatWidget> Logger
@rendermode RenderMode.InteractiveServer

@if (_isOpen)
{
    <div class="chat-widget-container">
        <div class="chat-widget-header">
            <div class="header-left">
                @if (!string.IsNullOrEmpty(_logoUrl))
                {
                    <img src="@_logoUrl" alt="Logo" class="chat-logo" />
                }
                <div class="header-title-wrapper">
                    <h2 class="chat-widget-title">
                        @_chatbotName
                    </h2>
                    <div class="offline-message">
                        <span class="@(_isOnline ? "online" : "")">@(_isOnline ? "√áevrimi√ßi" : "√áevrimdƒ±≈üƒ±")</span>
                    </div>
                </div>
            </div>
            <div class="header-actions">
                <button class="chat-widget-end-chat" @onclick="HandleEndChat" title="Konu≈ümayƒ± Sonlandƒ±r">
                    <svg xmlns="http://www.w3.org/2000/svg" height="20" viewBox="0 0 24 24" width="20" fill="currentColor">
                        <path d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"></path>
                    </svg>
                </button>
                <button class="chat-widget-close exit-chat" @onclick="ToggleChat" title="Kapat">
                    <svg xmlns="http://www.w3.org/2000/svg" height="24" viewBox="0 0 24 24" width="24" id="ic-minimize">
                        <path d="M0 0h24v24H0z" fill="none"></path>
                        <path d="M11.67 3.87L9.9 2.1 0 12l9.9 9.9 1.77-1.77L3.54 12z"></path>
                    </svg>
                </button>
            </div>
        </div>

        <div class="chat-widget-messages" @ref="_messagesContainer">
            <div class="messages-wrapper">
                @foreach (var message in _messages)
                {
                    var hasCards = (message.Dealers != null && message.Dealers.Any()) || (message.Tires != null && message.Tires.Any());
                    <div class="message-wrap">
                        <div class="message @(message.IsUser ? "message-visitor" : "message-operator") @(hasCards ? "with-cards" : string.Empty)">
                            <span class="message-content">
                                @if (message.IsLoading)
                                {
                                    <div class="dot-flashing"></div>
                                }
                                else if (!string.IsNullOrEmpty(message.ErrorMessage))
                                {
                                    <div class="error-message">
                                        <strong>‚ö†Ô∏è Hata:</strong> @message.ErrorMessage
                                    </div>
                                }
                                else
                                {
                                    @if (!string.IsNullOrEmpty(message.Content))
                                    {
                                        <div class="message-text">
                                            @((MarkupString)FormatMessage(message.Content, message.IsUser))
                                        </div>
                                    }
                                    
                                    @if (message.Dealers != null && message.Dealers.Any())
                                    {
                                        <div class="dealers-container">
                                            @foreach (var dealer in message.Dealers)
                                            {
                                                <div class="dealer-card">
                                                    <div class="dealer-header">
                                                        <h3 class="dealer-name">@dealer.FullName</h3>
                                                        @if (dealer.Distance.HasValue)
                                                        {
                                                            <span class="dealer-distance">@dealer.Distance.Value.ToString("F2") km</span>
                                                        }
                                                    </div>
                                                    <div class="dealer-info">
                                                        <div class="dealer-address">
                                                            <span class="icon">üìç</span>
                                                            <span>@dealer.FullAddress</span>
                                                        </div>
                                                        <div class="dealer-location">
                                                            <span class="icon">üèôÔ∏è</span>
                                                            <span>@dealer.Il @dealer.Ilce</span>
                                                        </div>
                                                        @if (!string.IsNullOrEmpty(dealer.Telefon1))
                                                        {
                                                            <div class="dealer-phone">
                                                                <span class="icon">üìû</span>
                                                                <a href="tel:@dealer.Telefon1">@dealer.Telefon1</a>
                                                            </div>
                                                        }
                                                        @if (!string.IsNullOrEmpty(dealer.Email))
                                                        {
                                                            <div class="dealer-email">
                                                                <span class="icon">‚úâÔ∏è</span>
                                                                <a href="mailto:@dealer.Email">@dealer.Email</a>
                                                            </div>
                                                        }
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(dealer.GoogleMapsUrl))
                                                    {
                                                        <div class="dealer-actions">
                                                            <a href="@dealer.GoogleMapsUrl" target="_blank" class="btn-maps">
                                                                üó∫Ô∏è Haritada G√∂ster
                                                            </a>
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    
                                    @if (message.Tires != null && message.Tires.Any())
                                    {
                                        <div class="tires-container">
                                            @foreach (var tire in message.Tires)
                                            {
                                                <div class="tire-card">
                                                    <div class="tire-header">
                                                        <h3 class="tire-name">@tire.Content</h3>
                                                        <span class="tire-season season-@tire.Season.ToLower()">@tire.Season</span>
                                                    </div>
                                                    @if (!string.IsNullOrEmpty(tire.Description))
                                                    {
                                                        <div class="tire-description">@tire.Description</div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(tire.AvailableSizes))
                                                    {
                                                        <div class="tire-sizes">
                                                            <span class="icon">üìè</span>
                                                            <span>@tire.AvailableSizes</span>
                                                        </div>
                                                    }
                                                    @if (tire.ProductUrls.Any())
                                                    {
                                                        <div class="tire-actions">
                                                            @foreach (var url in tire.ProductUrls.Take(3))
                                                            {
                                                                <a href="@url" target="_blank" class="btn-product">
                                                                    √úr√ºn√º G√∂r√ºnt√ºle
                                                                </a>
                                                            }
                                                        </div>
                                                    }
                                                </div>
                                            }
                                        </div>
                                    }
                                    
                                    @if (message.ShowLocationButton)
                                    {
                                        <div class="location-button-container">
                                            <button class="btn-location" @onclick="() => RequestLocation()">
                                                üìç Konumumu Payla≈ü
                                            </button>
                                        </div>
                                    }
                                }
                            </span>
                            <div class="message-timestamp">@message.Timestamp.ToString("HH:mm")</div>
                        </div>
                    </div>
                }
                
                @if (_showTypingIndicator)
                {
                    <div class="message-wrap">
                        <div class="message message-operator typing-indicator">
                            <span class="message-content">
                                <div class="typing-dots">
                                    <span></span>
                                    <span></span>
                                    <span></span>
                                </div>
                                <span class="typing-text">Yazƒ±yor...</span>
                            </span>
                        </div>
                    </div>
                }
            </div>
        </div>

        <div class="chat-widget-input-container">
            @if (_quickReplies.Any())
            {
                <div class="quick-replies">
                    @foreach (var quick in _quickReplies)
                    {
                        @if (!_usedQuickReplies.Contains(quick))
                        {
                            <button type="button"
                                    class="quick-reply-btn"
                                    style="border: 1px solid @_secondaryColor; color: @_secondaryColor;"
                                    disabled="@(!_isOnline || _isProcessing)"
                                    @onclick="() => SendQuickMessage(quick)">
                                @quick
                            </button>
                        }
                    }
                </div>
            }
            <EditForm Model="@_inputModel" OnValidSubmit="HandleSendMessage">
                <div class="footer-input-wrapper">
                    <div class="input-container">
                        <textarea @bind="_inputModel.Message" 
                                  @bind:event="oninput"
                                  id="message-textarea"
                                  class="chat-input" 
                                  placeholder="Mesajƒ±nƒ±zƒ± yazƒ±n.."
                                  rows="1"
                                  maxlength="400"
                                  disabled="@(_isProcessing || !_isOnline)"
                                  @ref="_inputTextArea"
                                  @onkeydown="HandleKeyDown"></textarea>
                        <button type="submit" 
                                class="send-button" 
                                disabled="@(_isProcessing || string.IsNullOrWhiteSpace(_inputModel.Message) || !_isOnline)">
                            @if (_isProcessing)
                            {
                                <div class="lds-ripple">
                                    <div></div>
                                    <div></div>
                                </div>
                            }
                            else
                            {
                                <svg id="ic_send" fill="#FFFFFF" height="20" viewBox="0 0 24 24" width="20" aria-hidden="true">
                                    <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"></path>
                                    <path d="M0 0h24v24H0z" fill="none"></path>
                                </svg>
                            }
                        </button>
                    </div>
                    <div class="input-footer">
                        <span class="char-count">@(_inputModel.Message?.Length ?? 0) / 400</span>
                    </div>
                </div>
            </EditForm>
        </div>
    </div>
}

<button class="chat-widget-toggle" style="background: linear-gradient(135deg, @_primaryColor 0%, @_primaryColorDark 100%); border: 3px solid @_secondaryColor; box-shadow: 0 4px 12px @(_secondaryColor + "66");" @onclick="ToggleChat">
    @if (!string.IsNullOrEmpty(_logoUrl))
    {
        <img src="@_logoUrl" alt="Logo" class="chat-toggle-logo" />
    }
    else
    {
        <span class="chat-toggle-icon">üí¨</span>
    }
    @if (_unreadCount > 0)
    {
        <span class="chat-toggle-badge" style="background: @_secondaryColor; border: 2px solid @_primaryColor;">@_unreadCount</span>
    }
</button>

@code {
    private List<ChatMessage> _messages = new();
    private ChatInputModel _inputModel = new();
    private bool _isProcessing = false;
    private bool _isOpen = false;
    private int _unreadCount = 0;
    private ElementReference _messagesContainer;
    private ElementReference _inputTextArea;
    private string _sessionId = Guid.NewGuid().ToString();
    
    // Appearance settings
    private string _chatbotName = "Bridgestone Chatbot";
    private string _logoUrl = string.Empty;
    private string _primaryColor = "#000000";
    private string _primaryColorDark = "#1a1a1a";
    private string _secondaryColor = "#dc143c";
    private bool _isOnline = true;
    private List<string> _quickReplies = new();
    private HashSet<string> _usedQuickReplies = new();
    private bool _showTypingIndicator = false;
    private bool _soundEnabled = true;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAppearanceSettings();
            await AddWelcomeMessage();
            await Task.Delay(100); // Wait for DOM to update
            await ScrollToBottom();
            await EnableCardDrag();
        }
        else
        {
            // Scroll after any message addition or update
            await Task.Delay(50); // Small delay to ensure DOM is updated
            await ScrollToBottom();
            await EnableCardDrag();
        }
    }

    private async Task LoadAppearanceSettings()
    {
        try
        {
            var settings = await AdminSettingsService.GetSettingsAsync();
            var domainAppearance = await GetDomainAppearanceOrDefault(settings);

            _chatbotName = domainAppearance.ChatbotName;
            _logoUrl = domainAppearance.ChatbotLogoUrl;
            _primaryColor = domainAppearance.PrimaryColor;
            _secondaryColor = domainAppearance.SecondaryColor;
            _isOnline = domainAppearance.ChatbotOnline;
            _quickReplies = domainAppearance.QuickReplies ?? new List<string>();
            _isOpen = domainAppearance.OpenChatOnLoad;
            
            // Calculate darker shade for gradient
            _primaryColorDark = DarkenColor(_primaryColor, 0.1);
            
            StateHasChanged();
        }
        catch
        {
            // Use defaults if settings can't be loaded
        }
    }

    private string DarkenColor(string hexColor, double factor)
    {
        try
        {
            hexColor = hexColor.TrimStart('#');
            var r = int.Parse(hexColor.Substring(0, 2), System.Globalization.NumberStyles.HexNumber);
            var g = int.Parse(hexColor.Substring(2, 2), System.Globalization.NumberStyles.HexNumber);
            var b = int.Parse(hexColor.Substring(4, 2), System.Globalization.NumberStyles.HexNumber);
            
            r = Math.Max(0, (int)(r * (1 - factor)));
            g = Math.Max(0, (int)(g * (1 - factor)));
            b = Math.Max(0, (int)(b * (1 - factor)));
            
            return $"#{r:X2}{g:X2}{b:X2}";
        }
        catch
        {
            return "#1a1a1a";
        }
    }

    private async Task AddWelcomeMessage()
    {
        var settings = await AdminSettingsService.GetSettingsAsync();
        var domainAppearance = await GetDomainAppearanceOrDefault(settings);
        var welcomeMessage = new ChatMessage
        {
            Content = domainAppearance.WelcomeMessage,
            IsUser = false,
            Timestamp = DateTime.UtcNow
        };
        _messages.Add(welcomeMessage);
    }

    private async Task ToggleChat()
    {
        _isOpen = !_isOpen;
        if (_isOpen)
        {
            _unreadCount = 0;
            StateHasChanged();
            await Task.Delay(100); // Wait for widget to open
            await ScrollToBottom();
        }
    }

    private async Task HandleEndChat()
    {
        // Ask user if they want to download chat history
        var downloadHistory = await JSRuntime.InvokeAsync<bool>("confirm", 
            "Konu≈üma ge√ßmi≈üini TXT formatƒ±nda indirmek ister misiniz?");
        
        if (downloadHistory)
        {
            await DownloadChatHistory();
        }
        
        // Clear context in service with OLD session ID before resetting
        var oldSessionId = _sessionId;
        try
        {
            ChatService.ClearContext(oldSessionId);
        }
        catch { }
        
        // Clear chat history and reset session with NEW session ID
        _messages.Clear();
        _unreadCount = 0;
        _sessionId = Guid.NewGuid().ToString();
        
        // Show welcome message again
        await LoadWelcomeMessage();
        
        StateHasChanged();
        await Task.Delay(100);
        await ScrollToBottom();
    }
    
    private async Task LoadWelcomeMessage()
    {
        await AddWelcomeMessage();
    }

    private async Task DownloadChatHistory()
    {
        try
        {
            var settings = await AdminSettingsService.GetSettingsAsync();
            var chatHistory = new System.Text.StringBuilder();
            
            chatHistory.AppendLine($"=== {settings.ChatbotName} - Konu≈üma Ge√ßmi≈üi ===");
            chatHistory.AppendLine($"Tarih: {DateTime.Now:dd.MM.yyyy HH:mm:ss}");
            chatHistory.AppendLine($"Session ID: {_sessionId}");
            chatHistory.AppendLine();
            chatHistory.AppendLine("--- Mesajlar ---");
            chatHistory.AppendLine();
            
            foreach (var message in _messages)
            {
                var sender = message.IsUser ? "Kullanƒ±cƒ±" : "Chatbot";
                var timestamp = message.Timestamp.ToString("dd.MM.yyyy HH:mm:ss");
                
                chatHistory.AppendLine($"[{timestamp}] {sender}:");
                
                if (!string.IsNullOrEmpty(message.Content))
                {
                    // Remove HTML tags and format text
                    var cleanContent = System.Text.RegularExpressions.Regex.Replace(
                        message.Content, "<.*?>", string.Empty);
                    chatHistory.AppendLine(cleanContent);
                }
                
                if (message.Dealers != null && message.Dealers.Any())
                {
                    chatHistory.AppendLine();
                    chatHistory.AppendLine("Bayiler:");
                    foreach (var dealer in message.Dealers)
                    {
                        chatHistory.AppendLine($"  - {dealer.FullName}");
                        chatHistory.AppendLine($"    Adres: {dealer.FullAddress}");
                        if (!string.IsNullOrEmpty(dealer.Telefon1))
                            chatHistory.AppendLine($"    Telefon: {dealer.Telefon1}");
                        if (!string.IsNullOrEmpty(dealer.Email))
                            chatHistory.AppendLine($"    Email: {dealer.Email}");
                        if (dealer.Distance.HasValue)
                            chatHistory.AppendLine($"    Mesafe: {dealer.Distance.Value:F2} km");
                        chatHistory.AppendLine();
                    }
                }
                
                if (message.Tires != null && message.Tires.Any())
                {
                    chatHistory.AppendLine();
                    chatHistory.AppendLine("Lastikler:");
                    foreach (var tire in message.Tires)
                    {
                        chatHistory.AppendLine($"  - {tire.Content}");
                        if (!string.IsNullOrEmpty(tire.Description))
                            chatHistory.AppendLine($"    A√ßƒ±klama: {tire.Description}");
                        if (!string.IsNullOrEmpty(tire.AvailableSizes))
                            chatHistory.AppendLine($"    Mevcut Boyutlar: {tire.AvailableSizes}");
                        chatHistory.AppendLine($"    Mevsim: {tire.Season}");
                        chatHistory.AppendLine();
                    }
                }
                
                if (!string.IsNullOrEmpty(message.ErrorMessage))
                {
                    chatHistory.AppendLine($"HATA: {message.ErrorMessage}");
                }
                
                chatHistory.AppendLine();
                chatHistory.AppendLine("---");
                chatHistory.AppendLine();
            }
            
            // Create filename with timestamp
            var fileName = $"chat_history_{DateTime.Now:yyyyMMdd_HHmmss}.txt";
            
            // Download file using JavaScript
            await JSRuntime.InvokeVoidAsync("downloadTextFile", fileName, chatHistory.ToString());
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Error downloading chat history");
            await JSRuntime.InvokeVoidAsync("alert", $"Chat ge√ßmi≈üi indirilirken hata olu≈ütu: {ex.Message}");
        }
    }

    private async Task HandleSendMessage()
    {
        if (!_isOnline)
            return;

        if (string.IsNullOrWhiteSpace(_inputModel.Message) || _isProcessing)
            return;

        var userMessage = _inputModel.Message.Trim();
        _inputModel.Message = string.Empty;
        StateHasChanged(); // Clear input immediately

        // Add user message
        var userMsg = new ChatMessage
        {
            Content = userMessage,
            IsUser = true,
            Timestamp = DateTime.UtcNow
        };
        _messages.Add(userMsg);
        StateHasChanged();
        await Task.Delay(50);
        await ScrollToBottom();

        // Show typing indicator
        _showTypingIndicator = true;
        _isProcessing = true;
        StateHasChanged();
        await Task.Delay(50);
        await ScrollToBottom();
        
        // Play typing sound if enabled
        if (_soundEnabled && _isOpen)
        {
            await PlaySound("typing");
        }

        try
        {
            var response = await ChatService.ProcessMessageAsync(userMessage, _sessionId);

            // Hide typing indicator
            _showTypingIndicator = false;
            
            // Check if response indicates location is needed
            bool showLocationButton = response.Message.Contains("konum") && 
                                     (response.Message.Contains("izin") || response.Message.Contains("payla≈ü") || response.Message.Contains("buton"));
            
            var botMsg = new ChatMessage
            {
                Content = response.Message,
                IsUser = false,
                Timestamp = DateTime.UtcNow,
                ShowLocationButton = showLocationButton,
                Dealers = response.Dealers,
                Tires = response.Tires
            };
            _messages.Add(botMsg);

            if (!_isOpen)
            {
                _unreadCount++;
            }
            
            // Play message received sound if enabled
            if (_soundEnabled)
            {
                await PlaySound("message");
            }
            
            StateHasChanged();
            await Task.Delay(100); // Wait for DOM to render cards
            await ScrollToBottom();
        }
        catch (Exception ex)
        {
            // Hide typing indicator
            _showTypingIndicator = false;
            
            var errorMsg = new ChatMessage
            {
                Content = string.Empty,
                IsUser = false,
                ErrorMessage = ex.Message,
                Timestamp = DateTime.UtcNow
            };
            _messages.Add(errorMsg);
            StateHasChanged();
            await Task.Delay(50);
            await ScrollToBottom();
        }
        finally
        {
            _showTypingIndicator = false;
            _isProcessing = false;
            StateHasChanged();
            
            // Focus back to input after sending message
            await Task.Delay(50); // Small delay to ensure DOM is updated
            await FocusInput();
        }
    }

    private async Task SendQuickMessage(string message)
    {
        if (_isProcessing || !_isOnline)
            return;

        _inputModel.Message = message;
        await HandleSendMessage();

        // Quick reply bu oturumda kullanƒ±ldƒ±, sadece UI'da gizle (admin ayarlarƒ±nƒ± etkileme)
        _usedQuickReplies.Add(message);
        StateHasChanged();
    }

    private async Task<DomainAppearance> GetDomainAppearanceOrDefault(AdminSettings fallback)
    {
        try
        {
            var uri = new Uri(NavManager.Uri);
            var query = Microsoft.AspNetCore.WebUtilities.QueryHelpers.ParseQuery(uri.Query);
            query.TryGetValue("domain", out var domainValues);
            var domainFromQuery = domainValues.FirstOrDefault();
            var domain = !string.IsNullOrWhiteSpace(domainFromQuery)
                ? domainFromQuery
                : uri.Host;

            var appearance = await DomainAppearanceService.GetAsync(domain);
            if (appearance != null)
            {
                return appearance;
            }
        }
        catch
        {
            // ignore and use fallback
        }

        // Fallback: genel admin ayarlarƒ±
        return new DomainAppearance
        {
            Domain = string.Empty,
            ChatbotName = fallback.ChatbotName,
            ChatbotLogoUrl = fallback.ChatbotLogoUrl,
            PrimaryColor = fallback.PrimaryColor,
            SecondaryColor = fallback.SecondaryColor,
            WelcomeMessage = fallback.WelcomeMessage,
            ChatbotOnline = fallback.ChatbotOnline,
            OpenChatOnLoad = fallback.OpenChatOnLoad,
            QuickReplies = fallback.QuickReplies ?? new List<string>()
        };
    }

    private async Task FocusInput()
    {
        try
        {
            if (_inputTextArea.Context != null)
            {
                await JSRuntime.InvokeVoidAsync("focusElement", _inputTextArea);
            }
        }
        catch
        {
            // Ignore JS errors
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        // Handle Enter key to submit form (Shift+Enter for new line)
        if (e.Key == "Enter" && !e.ShiftKey && !_isProcessing && !string.IsNullOrWhiteSpace(_inputModel.Message))
        {
            // Prevent default behavior via JavaScript if needed
            await HandleSendMessage();
        }
    }

    private string FormatMessage(string content, bool isUser = false)
    {
        if (string.IsNullOrEmpty(content))
            return string.Empty;

        // Convert markdown-style formatting to HTML
        var strongColor = isUser ? "white" : _secondaryColor;
        content = System.Text.RegularExpressions.Regex.Replace(content, @"\*\*(.*?)\*\*", $"<strong style=\"color: {strongColor};\">$1</strong>");
        content = System.Text.RegularExpressions.Regex.Replace(content, @"\n", "<br/>");
        
        return content;
    }

    private async Task ScrollToBottom()
    {
        try
        {
            if (_messagesContainer.Context != null)
            {
                await JSRuntime.InvokeVoidAsync("scrollToBottom", _messagesContainer);
            }
        }
        catch
        {
            // Ignore JS errors
        }
    }

    private async Task EnableCardDrag()
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("enableDragScroll", ".dealers-container, .tires-container");
        }
        catch
        {
            // Ignore JS errors
        }
    }

    private async Task RequestLocation()
    {
        try
        {
            // Request location from browser
            var location = await JSRuntime.InvokeAsync<LocationResult>("getCurrentLocation");
            
            if (location != null && location.Success)
            {
                // Add user message showing location was shared
                var userMsg = new ChatMessage
                {
                    Content = $"üìç Konumum payla≈üƒ±ldƒ±",
                    IsUser = true,
                    Timestamp = DateTime.UtcNow
                };
                _messages.Add(userMsg);
                StateHasChanged();
                await Task.Delay(50);
                await ScrollToBottom();

        // Show typing indicator
        _showTypingIndicator = true;
        _isProcessing = true;
        StateHasChanged();
        await Task.Delay(50);
        await ScrollToBottom();
        
        // Play typing sound if enabled and widget is open
        if (_soundEnabled && _isOpen)
        {
            await PlaySound("typing");
        }

                // Create location message for API
                var locationMessage = $"Latitude {location.Latitude}, Longitude {location.Longitude}";
                
                // Process location-based dealer search directly
                var response = await ChatService.ProcessMessageAsync(locationMessage, _sessionId);

                // Hide typing indicator
                _showTypingIndicator = false;
                
                var botMsg = new ChatMessage
                {
                    Content = response.Message,
                    IsUser = false,
                    Timestamp = DateTime.UtcNow,
                    Dealers = response.Dealers,
                    Tires = response.Tires
                };
                _messages.Add(botMsg);
                
                // Play message received sound if enabled
                if (_soundEnabled)
                {
                    await PlaySound("message");
                }
                
                StateHasChanged();
                await Task.Delay(100);
                await ScrollToBottom();
            }
            else
            {
                // Location denied or error
                var errorMsg = new ChatMessage
                {
                    Content = "Konum izni verilmedi veya konum alƒ±namadƒ±. L√ºtfen konumunuzu manuel olarak payla≈üƒ±n (√∂rnek: Latitude 41.0082, Longitude 28.9784)",
                    IsUser = false,
                    Timestamp = DateTime.UtcNow
                };
                _messages.Add(errorMsg);
                StateHasChanged();
                await Task.Delay(50);
                await ScrollToBottom();
            }
        }
        catch (Exception ex)
        {
            var errorMsg = new ChatMessage
            {
                Content = $"Konum alƒ±nƒ±rken hata olu≈ütu: {ex.Message}. L√ºtfen konumunuzu manuel olarak payla≈üƒ±n.",
                IsUser = false,
                Timestamp = DateTime.UtcNow
            };
            _messages.Add(errorMsg);
            StateHasChanged();
            await Task.Delay(50);
            await ScrollToBottom();
        }
        finally
        {
            _showTypingIndicator = false;
            _isProcessing = false;
            StateHasChanged();
        }
    }
    
    private async Task PlaySound(string soundType)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("playChatSound", soundType);
        }
        catch (Exception ex)
        {
            Logger.LogWarning(ex, "Failed to play sound: {SoundType}", soundType);
        }
    }

    private class ChatInputModel
    {
        public string Message { get; set; } = string.Empty;
    }

    private class LocationResult
    {
        public bool Success { get; set; }
        public double Latitude { get; set; }
        public double Longitude { get; set; }
        public string? Error { get; set; }
    }
}

<style>
    :root {
        --chatbot-primary-color: @_primaryColor;
        --chatbot-secondary-color: @_secondaryColor;
        --chatbot-gradient: linear-gradient(135deg, @_primaryColor 0%, @_primaryColorDark 100%);
    }

    /* Floating Chat Widget Styles - Modern Professional Theme */
    .chat-widget-toggle {
        position: fixed !important;
        bottom: 20px !important;
        right: 20px !important;
        width: 60px !important;
        height: 60px !important;
        border-radius: 28px !important;
        color: white !important;
        font-size: 1.5rem !important;
        cursor: pointer !important;
        z-index: 1000 !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        transition: all 0.3s ease-in-out !important;
        padding: 0 !important;
        box-shadow: 0 0 34px -10px var(--chatbot-primary-color) !important;
    }

    .chat-widget-toggle:hover {
        transform: scale(1.1) !important;
        box-shadow: 0 0 40px -5px var(--chatbot-primary-color) !important;
    }

    .chat-toggle-icon {
        display: block;
    }

    .chat-toggle-logo {
        width: 32px;
        height: 32px;
        object-fit: contain;
        display: block;
    }

    .chat-toggle-badge {
        position: absolute;
        top: -5px;
        right: -5px;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        font-size: 0.75rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .chat-widget-container {
        position: fixed !important;
        bottom: 90px !important;
        right: 20px !important;
        width: 372px !important;
        max-width: calc(100vw - 40px) !important;
        height: 600px !important;
        max-height: calc(100vh - 120px) !important;
        background: #ffffff !important;
        border-radius: 16px !important;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12), 0 2px 8px rgba(0, 0, 0, 0.08) !important;
        display: flex !important;
        flex-direction: column !important;
        z-index: 1001 !important;
        overflow: hidden !important;
        animation: slideInUp 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
        border: none !important;
        opacity: 1 !important;
        visibility: visible !important;
    }
    
    @@media (max-width: 768px) {
        .chat-widget-container {
            bottom: 0 !important;
            right: 0 !important;
            left: 0 !important;
            width: 100% !important;
            max-width: 100% !important;
            height: 100vh !important;
            max-height: 100vh !important;
            border-radius: 0 !important;
        }
    }

    /* Host sayfa CSS'ini minimuma indirmek i√ßin temel reset */
    .chat-widget-container, .chat-widget-container * {
        box-sizing: border-box !important;
        font-family: inherit !important;
    }

    @@keyframes slideInUp {
        from {
            opacity: 0;
            transform: translateY(20px) scale(0.95);
        }
        to {
            opacity: 1;
            transform: translateY(0) scale(1);
        }
    }

    .chat-widget-header {
        background: var(--chatbot-gradient) !important;
        color: white !important;
        padding: 16px 20px !important;
        display: flex !important;
        justify-content: space-between !important;
        align-items: center !important;
        border-bottom: none !important;
        position: relative !important;
        z-index: 4 !important;
        flex: 0 0 auto !important;
        min-height: 64px !important;
    }

    .header-left {
        display: flex !important;
        align-items: center !important;
        gap: 12px !important;
        flex: 1 !important;
        min-width: 0 !important;
    }

    .header-title-wrapper {
        display: flex !important;
        flex-direction: column !important;
        gap: 4px !important;
        flex: 1 !important;
        min-width: 0 !important;
    }

    .chat-widget-title {
        font-size: 18px !important;
        font-weight: 600 !important;
        color: #ffffff !important;
        margin: 0 !important;
        padding: 0 !important;
        line-height: 1.3 !important;
        text-overflow: ellipsis !important;
        white-space: nowrap !important;
        overflow: hidden !important;
    }

    .header-actions {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        flex-shrink: 0 !important;
    }

    .chat-logo {
        width: 40px !important;
        height: 40px !important;
        object-fit: contain !important;
        display: block !important;
        flex-shrink: 0 !important;
        border-radius: 8px !important;
        background: rgba(255, 255, 255, 0.1) !important;
        padding: 4px !important;
    }

    .chat-icon {
        font-size: 1.25rem;
    }

    .chat-widget-header-actions {
        display: flex;
        gap: 0.5rem;
        align-items: center;
    }

    .status-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        display: inline-block;
        border: 1px solid #ffffff99;
    }

    .status-dot.online {
        background: #2ecc71;
        box-shadow: 0 0 6px #2ecc71;
    }

    .status-dot.offline {
        background: #e74c3c;
        box-shadow: 0 0 6px #e74c3c;
    }

    .status-text {
        font-size: 0.85rem;
        opacity: 0.9;
    }

    .chat-widget-close {
        background: rgba(255, 255, 255, 0.2) !important;
        border: none !important;
        border-radius: 8px !important;
        color: #ffffff !important;
        cursor: pointer !important;
        padding: 6px !important;
        user-select: none !important;
        outline: none !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        transition: all 0.2s ease !important;
        width: 32px !important;
        height: 32px !important;
    }

    .chat-widget-close:hover {
        background: rgba(255, 255, 255, 0.3) !important;
    }

    .chat-widget-end-chat {
        background: rgba(255, 255, 255, 0.2) !important;
        border: none !important;
        border-radius: 8px !important;
        color: #ffffff !important;
        cursor: pointer !important;
        padding: 6px !important;
        user-select: none !important;
        outline: none !important;
        display: flex !important;
        align-items: center !important;
        justify-content: center !important;
        transition: all 0.2s ease !important;
        width: 32px !important;
        height: 32px !important;
    }

    .chat-widget-end-chat:hover {
        background: rgba(255, 255, 255, 0.3) !important;
    }

    .chat-widget-close svg {
        fill: currentcolor !important;
    }

    .chat-widget-close.exit-chat svg#ic-minimize {
        padding: 3px 0 !important;
        transform: rotate(270deg) translate(3px, 0px) !important;
    }

    .offline-message {
        padding: 0 !important;
        margin: 0 !important;
        color: rgba(255, 255, 255, 0.9) !important;
        font-size: 12px !important;
        line-height: 1.4 !important;
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
    }

    .offline-message span.online {
        padding-left: 0 !important;
    }

    .offline-message span {
        display: flex !important;
        align-items: center !important;
        gap: 6px !important;
    }

    .offline-message span.online::before {
        content: "" !important;
        display: block !important;
        width: 8px !important;
        height: 8px !important;
        background: rgb(88, 183, 67) !important;
        border-radius: 50% !important;
        flex-shrink: 0 !important;
        box-shadow: 0 0 4px rgba(88, 183, 67, 0.5) !important;
    }


    .chat-widget-messages {
        flex: 1 1 auto !important;
        overflow-y: auto !important;
        overflow-x: hidden !important;
        padding: 20px 24px !important;
        width: 100% !important;
        background: #fafbfc !important;
        scroll-behavior: smooth !important;
        margin-bottom: 0px !important;
        min-height: 0 !important;
    }

    .chat-widget-messages::-webkit-scrollbar {
        width: 6px !important;
    }

    .chat-widget-messages::-webkit-scrollbar-track {
        background: transparent !important;
    }

    .chat-widget-messages::-webkit-scrollbar-thumb {
        background: rgba(0, 0, 0, 0.2) !important;
        border-radius: 3px !important;
    }

    .chat-widget-messages::-webkit-scrollbar-thumb:hover {
        background: rgba(0, 0, 0, 0.3) !important;
    }

    .messages-wrapper {
        display: flex !important;
        flex-direction: column !important;
        gap: 12px !important;
        width: 100% !important;
        padding-bottom: 8px !important;
    }

    .message-wrap {
        width: 100% !important;
        display: flex !important;
        flex-direction: column !important;
    }

    .message {
        padding: 12px 16px !important;
        border-radius: 18px !important;
        font-size: 14px !important;
        line-height: 1.5 !important;
        overflow-wrap: break-word !important;
        word-wrap: break-word !important;
        max-width: 80% !important;
        position: relative !important;
        animation: messageSlideIn 0.2s ease-out !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    .message.with-cards {
        max-width: 100% !important;
    }

    @@keyframes messageSlideIn {
        from {
            opacity: 0;
            transform: translateY(8px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .message-operator {
        align-self: flex-start !important;
        color: #1a1a1a !important;
        background: #ffffff !important;
        border: 1px solid #e5e7eb !important;
    }

    .message-visitor {
        align-self: flex-end !important;
        color: #ffffff !important;
        background: var(--chatbot-gradient) !important;
        border: none !important;
    }

    .message-content {
        display: block !important;
    }

    .message.with-cards .message-content {
        width: 100% !important;
    }

    .message-text {
        line-height: 1.5 !important;
        word-wrap: break-word !important;
    }

    .message-text strong {
        font-weight: 600 !important;
    }

    .message-timestamp {
        bottom: -24px !important;
        font-size: 12px !important;
        color: rgb(136, 148, 171) !important;
        position: absolute !important;
        transition: all 0.2s ease !important;
        white-space: nowrap !important;
        display: none !important;
    }

    .message-operator .message-timestamp {
        height: 23px !important;
        align-items: center !important;
        top: calc(100% + 4px) !important;
        left: 12px !important;
    }

    .message-visitor .message-timestamp {
        right: 12px !important;
    }

    .message:last-child .message-timestamp {
        display: flex !important;
    }

    .loading-indicator {
        padding: 0.5rem;
    }

    .dot-flashing {
        position: relative !important;
        width: 10px !important;
        height: 10px !important;
        border-radius: 5px !important;
        background-color: var(--chatbot-primary-color) !important;
        color: var(--chatbot-primary-color) !important;
        animation: dot-flashing 1s infinite linear alternate !important;
        animation-delay: 0.5s !important;
        margin: 5px 16px !important;
    }

    .dot-flashing::before, .dot-flashing::after {
        content: "" !important;
        display: inline-block !important;
        position: absolute !important;
        top: 0 !important;
    }

    .dot-flashing::before {
        left: -15px !important;
        width: 10px !important;
        height: 10px !important;
        border-radius: 5px !important;
        background-color: var(--chatbot-primary-color) !important;
        color: var(--chatbot-primary-color) !important;
        animation: dot-flashing 1s infinite alternate !important;
        animation-delay: 0s !important;
    }

    .dot-flashing::after {
        left: 15px !important;
        width: 10px !important;
        height: 10px !important;
        border-radius: 5px !important;
        background-color: var(--chatbot-primary-color) !important;
        color: var(--chatbot-primary-color) !important;
        animation: dot-flashing 1s infinite alternate !important;
        animation-delay: 1s !important;
    }

    @@keyframes dot-flashing {
        0% {
            background-color: var(--chatbot-primary-color) !important;
        }
        50%, 100% {
            background-color: rgba(0, 0, 0, 0.2) !important;
        }
    }

    .error-message {
        padding: 0.5rem;
    }

    /* Typing Indicator */
    .typing-indicator {
        padding: 12px 16px !important;
    }

    .typing-dots {
        display: inline-flex !important;
        align-items: center !important;
        gap: 4px !important;
        margin-right: 8px !important;
        vertical-align: middle !important;
    }

    .typing-dots span {
        width: 8px !important;
        height: 8px !important;
        border-radius: 50% !important;
        background-color: #999 !important;
        display: inline-block !important;
        animation: typing-bounce 1.4s infinite ease-in-out !important;
    }

    .typing-dots span:nth-child(1) {
        animation-delay: -0.32s !important;
    }

    .typing-dots span:nth-child(2) {
        animation-delay: -0.16s !important;
    }

    .typing-dots span:nth-child(3) {
        animation-delay: 0s !important;
    }

    @@keyframes typing-bounce {
        0%, 80%, 100% {
            transform: scale(0.8) !important;
            opacity: 0.5 !important;
        }
        40% {
            transform: scale(1) !important;
            opacity: 1 !important;
        }
    }

    .typing-text {
        font-size: 13px !important;
        color: #666 !important;
        font-style: italic !important;
        vertical-align: middle !important;
    }

    .chat-widget-input-container {
        padding: 16px 20px !important;
        width: 100% !important;
        position: relative !important;
        background: #ffffff !important;
        border-top: 1px solid #e5e7eb !important;
        z-index: 3 !important;
        flex: 0 0 auto !important;
    }

    .footer-input-wrapper {
        width: 100% !important;
    }

    .input-container {
        position: relative !important;
        display: flex !important;
        flex-direction: row !important;
        align-items: flex-end !important;
        gap: 8px !important;
        width: 100% !important;
    }

    .input-footer {
        display: flex !important;
        justify-content: flex-end !important;
        align-items: center !important;
        padding-top: 6px !important;
        margin-top: 4px !important;
    }

    .char-count {
        color: rgb(136, 148, 171) !important;
        font-size: 11px !important;
        font-weight: 400 !important;
    }


    #message-textarea::-webkit-scrollbar {
        display: none !important;
    }

    #message-textarea:disabled {
        cursor: not-allowed !important;
    }

    .lds-ripple {
        display: inline-block !important;
        position: relative !important;
        width: 38px !important;
        height: 38px !important;
    }

    .lds-ripple div {
        position: absolute !important;
        border: 4px solid var(--chatbot-primary-color) !important;
        opacity: 1 !important;
        border-radius: 50% !important;
        animation: lds-ripple 1s cubic-bezier(0, 0.2, 0.8, 1) infinite !important;
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
    }

    .lds-ripple div:nth-child(2) {
        animation-delay: -0.5s !important;
    }

    @@keyframes lds-ripple {
        0% {
            width: 0;
            height: 0;
            opacity: 0;
        }
        4.9% {
            width: 0;
            height: 0;
            opacity: 0;
        }
        5% {
            width: 0;
            height: 0;
            opacity: 1;
        }
        100% {
            width: calc(100%);
            height: calc(100%);
            opacity: 0;
        }
    }

    .quick-replies {
        display: flex !important;
        flex-wrap: wrap !important;
        gap: 8px !important;
        margin-bottom: 12px !important;
        padding: 0 !important;
    }

    .quick-reply-btn {
        background: #fafafa !important;
        color: var(--chatbot-primary-color) !important;
        border: 2px solid var(--chatbot-primary-color) !important;
        border-radius: 20px !important;
        padding: 8px 16px !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        cursor: pointer !important;
        transition: all 0.2s ease !important;
        white-space: nowrap !important;
        display: inline-flex !important;
        align-items: center !important;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05) !important;
    }

    .quick-reply-btn:hover:not(:disabled) {
        color: rgb(255, 255, 255) !important;
        background: var(--chatbot-primary-color) !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15) !important;
    }

    .quick-reply-btn:disabled {
        opacity: 0.5 !important;
        cursor: not-allowed !important;
    }

    .input-group {
        display: flex !important;
        gap: 0.5rem !important;
        align-items: center !important;
        width: 100% !important;
    }

    .chat-input {
        border: 1px solid #e5e7eb !important;
        border-radius: 12px !important;
        width: 100% !important;
        font-size: 14px !important;
        padding: 12px 16px !important;
        resize: none !important;
        line-height: 1.5 !important;
        overflow-x: hidden !important;
        flex: 1 !important;
        font-family: inherit !important;
        background: #ffffff !important;
        color: #1a1a1a !important;
        transition: all 0.2s ease !important;
    }
    
    .chat-input:focus {
        outline: none !important;
        border-color: var(--chatbot-primary-color) !important;
        box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.05) !important;
    }

    .chat-input:focus {
        outline: none !important;
        border: 0 !important;
    }

    .chat-input::placeholder {
        color: rgb(136, 148, 171) !important;
        opacity: 1 !important;
    }

    .chat-input:disabled {
        background-color: #f5f5f5 !important;
        cursor: not-allowed !important;
        opacity: 0.6 !important;
    }

    .send-button {
        padding: 0 !important;
        color: white !important;
        border-radius: 12px !important;
        cursor: pointer !important;
        font-size: 1.05rem !important;
        transition: all 0.2s ease-in-out !important;
        min-width: 44px !important;
        width: 44px !important;
        height: 44px !important;
        display: inline-flex !important;
        align-items: center !important;
        justify-content: center !important;
        background: var(--chatbot-primary-color) !important;
        border: none !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12) !important;
        margin-left: 8px !important;
    }

    .send-button:hover:not(:disabled) {
        background: var(--chatbot-secondary-color) !important;
        transform: scale(1.05) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2) !important;
    }

    .send-button:disabled {
        opacity: 0.5 !important;
        cursor: not-allowed !important;
        transform: none !important;
    }

    .send-button svg {
        width: 20px !important;
        height: 20px !important;
        fill: rgb(255, 255, 255) !important;
        transition: all 0.2s ease-in-out !important;
    }


    .offline-hint {
        margin-top: 0.5rem;
        font-size: 0.85rem;
        color: #b33a3a;
    }

    /* Scrollbar styling */
    .chat-widget-messages::-webkit-scrollbar {
        width: 6px;
    }

    .chat-widget-messages::-webkit-scrollbar-track {
        background: #f1f1f1;
    }

    .chat-widget-messages::-webkit-scrollbar-thumb {
        background: var(--secondary-color, #dc143c);
        border-radius: 3px;
    }

    .chat-widget-messages::-webkit-scrollbar-thumb:hover {
        opacity: 0.8;
    }

    .location-button-container {
        margin-top: 0.75rem;
        padding-top: 0.75rem;
        border-top: 1px solid rgba(0, 0, 0, 0.1);
    }

    .btn-location {
        padding: 10px 16px !important;
        color: white !important;
        border: none !important;
        border-radius: 8px !important;
        cursor: pointer !important;
        font-size: 14px !important;
        font-weight: 500 !important;
        transition: all 0.2s ease !important;
        width: 100% !important;
        background: var(--chatbot-secondary-color) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1) !important;
    }

    .btn-location:hover {
        opacity: 0.9 !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15) !important;
    }

    /* Dealer Cards */
    .dealers-container {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 0.75rem !important;
        margin-top: 0.75rem !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
        padding-bottom: 0.5rem !important;
        padding-right: 3rem !important; /* peek for next card */
        scroll-snap-type: x mandatory !important;
        -webkit-overflow-scrolling: touch !important;
        scrollbar-width: thin !important;
        scrollbar-color: #ccc transparent !important;
        scroll-behavior: smooth !important;
        cursor: grab !important;
    }

    .dealers-container.dragging {
        cursor: grabbing !important;
    }

    .dealer-card {
        background: white !important;
        border: 1px solid rgba(0, 0, 0, 0.08) !important;
        border-radius: 12px !important;
        padding: 16px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
        transition: all 0.2s ease !important;
        margin-top: 12px !important;
        width: 260px !important;
        max-width: 280px !important;
        flex: 0 0 auto !important;
        scroll-snap-align: start !important;
    }

    .dealer-card:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12) !important;
    }

    .dealer-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
        gap: 0.5rem;
    }

    .dealer-name {
        margin: 0 !important;
        font-size: 16px !important;
        font-weight: 600 !important;
        color: rgb(6, 19, 43) !important;
        flex: 1 !important;
        line-height: 1.4 !important;
    }

    .dealer-distance {
        background: var(--chatbot-secondary-color) !important;
        color: white !important;
        padding: 4px 10px !important;
        border-radius: 12px !important;
        font-size: 12px !important;
        font-weight: 600 !important;
        white-space: nowrap !important;
    }

    .dealer-info {
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        margin-bottom: 0.5rem;
    }

    .dealer-info > div {
        display: flex !important;
        align-items: flex-start !important;
        gap: 8px !important;
        font-size: 14px !important;
        color: rgb(6, 19, 43) !important;
        line-height: 1.5 !important;
        margin-bottom: 6px !important;
    }

    .dealer-info .icon {
        font-size: 0.9rem;
        flex-shrink: 0;
    }

    .dealer-info a {
        text-decoration: none !important;
        color: var(--chatbot-secondary-color) !important;
        font-weight: 500 !important;
        transition: all 0.2s ease !important;
    }

    .dealer-info a:hover {
        text-decoration: underline !important;
        opacity: 0.8 !important;
    }

    .dealer-actions {
        margin-top: 0.5rem;
        padding-top: 0.5rem;
        border-top: 1px solid #e0e0e0;
    }

    .btn-maps {
        display: inline-block !important;
        padding: 8px 16px !important;
        color: white !important;
        text-decoration: none !important;
        border-radius: 8px !important;
        font-size: 13px !important;
        font-weight: 500 !important;
        transition: all 0.2s ease !important;
        background: var(--chatbot-secondary-color) !important;
    }

    .btn-maps:hover {
        opacity: 0.9 !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
    }

    /* Tire Cards */
    .tires-container {
        display: flex !important;
        flex-direction: row !important;
        flex-wrap: nowrap !important;
        gap: 0.75rem !important;
        margin-top: 0.75rem !important;
        overflow-x: auto !important;
        overflow-y: hidden !important;
        padding-bottom: 0.5rem !important;
        padding-right: 3rem !important; /* peek for next card */
        scroll-snap-type: x mandatory !important;
        -webkit-overflow-scrolling: touch !important;
        scrollbar-width: thin !important;
        scrollbar-color: #ccc transparent !important;
        scroll-behavior: smooth !important;
        cursor: grab !important;
    }

    .tires-container.dragging {
        cursor: grabbing !important;
    }

    .tire-card {
        background: white !important;
        border: 1px solid rgba(0, 0, 0, 0.08) !important;
        border-radius: 12px !important;
        padding: 16px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.08) !important;
        transition: all 0.2s ease !important;
        margin-top: 12px !important;
        width: 260px !important;
        max-width: 280px !important;
        flex: 0 0 auto !important;
        scroll-snap-align: start !important;
    }

    .tire-card:hover {
        transform: translateY(-2px) !important;
        box-shadow: 0 4px 12px rgba(0,0,0,0.12) !important;
    }

    .tire-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 0.5rem;
        gap: 0.5rem;
    }

    .tire-name {
        margin: 0 !important;
        font-size: 16px !important;
        font-weight: 600 !important;
        color: rgb(6, 19, 43) !important;
        flex: 1 !important;
        line-height: 1.4 !important;
    }

    .tire-season {
        padding: 0.2rem 0.6rem;
        border-radius: 20px;
        font-size: 0.7rem;
        font-weight: 600;
        white-space: nowrap;
        text-transform: uppercase;
    }

    .season-yaz, .season-summer {
        background: #ffd700;
        color: #333;
    }

    .season-kƒ±≈ü, .season-winter {
        background: #4a90e2;
        color: white;
    }

    .season-d√∂rt mevsim, .season-all season {
        background: #50c878;
        color: white;
    }

    .tire-description {
        font-size: 14px !important;
        color: rgb(136, 148, 171) !important;
        margin-bottom: 8px !important;
        line-height: 1.5 !important;
    }

    .tire-sizes {
        display: flex !important;
        align-items: center !important;
        gap: 8px !important;
        font-size: 14px !important;
        color: rgb(6, 19, 43) !important;
        margin-bottom: 8px !important;
    }

    .tire-sizes .icon {
        font-size: 0.9rem;
    }

    .tire-actions {
        margin-top: auto;
        display: flex;
        flex-direction: column;
        gap: 0.4rem;
        padding-top: 0.5rem;
        border-top: 1px solid #e0e0e0;
    }

    .btn-product {
        display: block !important;
        padding: 8px 16px !important;
        color: white !important;
        text-decoration: none !important;
        border-radius: 8px !important;
        font-size: 13px !important;
        font-weight: 500 !important;
        text-align: center !important;
        transition: all 0.2s ease !important;
        background: var(--chatbot-secondary-color) !important;
        margin-bottom: 6px !important;
    }

    .btn-product:hover {
        opacity: 0.9 !important;
        transform: translateY(-1px) !important;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15) !important;
    }

    @@media (max-width: 768px) {
        .chat-widget-container {
            width: calc(100vw - 40px) !important;
            height: calc(100vh - 120px) !important;
            right: 20px !important;
            left: 20px !important;
        }
        
        .message {
            max-width: 85% !important;
        }
    }
</style>

